<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Durga Puja Pandal Hopper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #map {
            min-height: 200px; /* Ensure map has a minimum height in flex-col */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gmaps-marker-label {
            font-size: 12px !important;
            font-weight: bold !important;
            color: black !important; 
        }
        /* Style for the draggable button container */
        #floating-buttons-container {
            cursor: move;
            touch-action: none; /* Prevents scrolling on touch devices */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <input type="text" id="date-picker" style="display: none;">

    <div id="main-container" class="flex flex-col md:flex-row h-screen max-h-screen relative overflow-hidden">
        <div id="sidebar" class="w-full md:w-2/5 p-2 md:p-4 bg-white shadow-lg flex flex-col h-screen z-30 md:relative">
            <div class="flex-shrink-0">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <h1 class="text-xl md:text-2xl font-bold ml-2">Durga Puja Pandal Hopper</h1>
                    </div>
                </div>

                <div id="status" class="p-3 bg-blue-100 text-blue-800 rounded-md text-center">
                    <p id="status-text">Getting your location...</p>
                    <button id="manual-location-btn" class="text-xs text-indigo-600 hover:underline mt-1 font-medium">Wrong location? Set manually</button>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mt-4">
                            <button id="theme-details-btn" disabled class="w-full bg-blue-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                                üé® Theme
                            </button>
                            <button id="plan-generator-btn" disabled class="w-full bg-purple-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-purple-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                                ‚ú® Plan
                            </button>
                            <button id="save-plan-btn" disabled class="w-full bg-green-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-green-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                                üíæ Save
                            </button>
                </div>
                <p id="plan-helper-text" class="text-xs text-center text-gray-500 mt-1">(Select 1 to 6 pandals for a plan)</p>


                <div id="navigation-container" class="mt-2 hidden">
                    <button id="start-navigation-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                        Navigate in Google Maps
                    </button>
                </div>
                
                <div class="mt-4 border-t pt-2">
                    <details>
                        <summary class="font-semibold cursor-pointer text-gray-700">Saved Plans</summary>
                        <div id="saved-plans-list" class="mt-2 max-h-32 overflow-y-auto custom-scrollbar pr-2 space-y-2">
                        </div>
                    </details>
                </div>

                <h2 class="text-lg font-semibold my-3 border-t pt-3">Select Pandals:</h2>
                <p class="text-xs text-gray-500 italic mb-2">* <strong class="text-indigo-600">Bolded</strong> pandals are must-watch locations.</p>
                <div class="mb-3">
                                <div class="relative">
                                    <input type="search" id="search-input" placeholder="Search for a pandal..." class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                                    <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                </div>
                                <button id="clear-all-btn" class="w-full mt-2 bg-red-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-red-600 transition-colors shadow-md text-sm">Clear Selections</button>
                </div>
            </div>
            
            <div id="location-list" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
            </div>
            <div class="mt-auto pt-4 text-center text-sm text-gray-500">
                <p>Created by <a href="https://github.com/saptarshisaha" class="text-indigo-600 hover:underline font-semibold" target="_blank" rel="noopener noreferrer">@saptarshisaha</a></p>
            </div>
        </div>

        <div id="map-container" class="flex-1 h-screen md:h-full w-full hidden md:flex">
            <div id="map" class="w-full h-full"></div>
        </div>
    </div>

    <div id="floating-buttons-container" class="md:hidden fixed bottom-4 right-4 z-40 flex flex-col items-center gap-3">
        <button id="car-parking-btn" title="Save Car Location" class="bg-green-500 text-white rounded-full p-4 shadow-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1 .4-1 1v12c0 .6.4 1 1 1h2"/><path d="M5 18h14"/><circle cx="7.5" cy="18.5" r="2.5"/><circle cx="17.5" cy="18.5" r="2.5"/></svg>
        </button>
        <button id="weather-forecast-btn" disabled class="bg-blue-500 text-white rounded-full p-4 shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-110 disabled:bg-gray-400 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
        </button>
        <button id="view-toggle-btn" class="bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>
        </button>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-purple-700"></h2>
            <div id="modal-content" class="min-h-[200px] max-h-[70vh] overflow-y-auto custom-scrollbar">
                <div id="modal-loader" class="flex items-center justify-center h-full">
                    <div class="spinner"></div>
                </div>
                <div id="modal-text" class="text-gray-700 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <div id="save-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 relative">
            <h2 class="text-xl font-bold mb-4">Save Your Plan</h2>
            <p class="text-sm text-gray-600 mb-2">Please enter a name for your plan:</p>
            <input type="text" id="plan-name-input" class="w-full border rounded p-2 mb-4" placeholder="e.g., Saptami Night Out">
            <div class="flex justify-end space-x-2">
                <button id="cancel-save-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirm-save-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

    <div id="share-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 relative">
            <h2 class="text-xl font-bold mb-4">Share Your Plan</h2>
            <p class="text-sm text-gray-600 mb-2">Copy this link and send it to your friends:</p>
            <input type="text" id="share-link-input" class="w-full border rounded p-2 mb-4 bg-gray-100" readonly>
            <div class="flex justify-end space-x-2">
                <button id="close-share-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Close</button>
                <button id="copy-share-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Copy</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const locations = [
            // North Kolkata
            { name: "Tala Prattoy Durga Puja Art", shortName: "Tala Prattoy", category: "North Kolkata", mustWatch: true },
            { name: "Tala Barowari Durga Puja", shortName: "Tala Barowari", category: "North Kolkata" ,mustWatch: true },
            { name: "Bagbazar Sarbojanin", shortName: "Bagbazar", category: "North Kolkata" },
            { name: "lalabagan nabankur", shortName: "Lalabagan", category: "North Kolkata" },
            { name: "Maniktala chaltabagan lohapatty", shortName: "Maniktala", category: "North Kolkata", mustWatch: true },
            { name: "Jagat Mukherjee Park", shortName: "Jagat M. Park", category: "North Kolkata" ,mustWatch: true },
            { name: "Sovabazar Rajbari", shortName: "Sovabazar", category: "North Kolkata" },
            { name: "Kashi Bose Lane Sarbojanin", shortName: "Kashi Bose Ln", category: "North Kolkata", mustWatch: true },
            { name: "Sikdar bagan Sadharan Durgotsab", shortName: "Sikdar Bagan", category: "North Kolkata" },
            { name: "Hatibagan NabinPally Durga Puja", shortName: "NabinPally", category: "North Kolkata" },
            { name: "Hatibagan Sarbojonin", shortName: "Hatibagan", category: "North Kolkata" },
            { name: "Kumartuli Park", shortName: "Kumartuli Park", category: "North Kolkata" },
            { name: "Kumortuli Sarbojonin Durgotsab", shortName: "Kumortuli", category: "North Kolkata" },
            { name: "Simla Byayam Samity", shortName: "Simla Byayam", category: "North Kolkata" },
            { name: "Ahiritola Sarbojanin", shortName: "Ahiritola", category: "North Kolkata" ,mustWatch: true },
            { name: "Pathuriaghata pancher pally", shortName: "Pathuriaghata", category: "North Kolkata" },
            { name: "Chorebagan Sarbojanin", shortName: "Chorebagan", category: "North Kolkata", mustWatch: true },
            { name: "Beniatola Sarbojonin Durgotsab", shortName: "Beniatola", category: "North Kolkata" },
            { name: "Gauri Bari Sarbojanin Durga Puja Pandal", shortName: "Gauri Bari", category: "North Kolkata" },

            // Lake Town / Ultadanga
            { name: "Telengabagan durgotsab", shortName: "Telengabagan", category: "Lake Town / Ultadanga" },
            { name: "Lake Town Adhibasi Brinda", shortName: "Lake Town", category: "Lake Town / Ultadanga" },
            { name: "Karbagan Sarbojanin Durgotsab Committee", shortName: "Karbagan", category: "Lake Town / Ultadanga" },
            { name: "Dakshindari Youth Forum Ground", shortName: "Dakshindari", category: "Lake Town / Ultadanga" ,mustWatch: true },

            // Dum Dum
            { name: "Dakshinpara Durgotsab Committee JC7C+9F5, Dakshinpara Rd, Satgachi, Baguiati, West Bengal 700028", shortName: "Dakshinpara DD", category: "Dum Dum" },
            { name: "Dum Dum Tarun Dal Club", shortName: "Tarun Dal", category: "Dum Dum", mustWatch: true },
            { name: "Dum Dum Park Sarbojanin Durga Puja Samity", shortName: "DD Park Sarbojanin", category: "Dum Dum" },
            { name: "Dum Dum Park Bharat Chakra", shortName: "DD Park Bharat", category: "Dum Dum", mustWatch: true },
            { name: "Aswininagar Bandhumahal Club, Baguiati", shortName: "Aswininagar", category: "Dum Dum" },
            { name: "Arjunpur Amra Sabai Club", shortName: "Arjunpur", category: "Dum Dum", mustWatch: true },
            { name: "Dum Dum Park Tarun Sangha",shortName: "Tarun Sangha",category: "Dum Dum", "mustWatch": true },

            // South Kolkata
            { name: "Suruchi Sangha", shortName: "Suruchi Sangha", category: "South Kolkata" ,mustWatch: true },
            { name: "Chetla Agrani Club", shortName: "Chetla Agrani", category: "South Kolkata" ,mustWatch: true },
            { name: "ALIPORE SARBOJANIN", shortName: "Alipore", category: "South Kolkata" ,mustWatch: true },
            { name: "66 Pally Durgapuja Pandal", shortName: "66 Pally", category: "South Kolkata" },
            { name: "Kalighat Milan Sangha", shortName: "Milan Sangha", category: "South Kolkata" },
            { name: "Chakraberia Sarbojanin Durgotsab", shortName: "Chakraberia", category: "South Kolkata" ,mustWatch: true },
            { name: "Abasar Sarbojanin Durgotsab Samity", shortName: "Abasar", category: "South Kolkata" },
            { name: "Tridhara Sammilani", shortName: "Tridhara", category: "South Kolkata" ,mustWatch: true },
            { name: "Mudiali Club Durga Puja Pandal", shortName: "Mudiali", category: "South Kolkata" },
            { name: "Shibmandir Sarbojanin Durgotsab Samiti", shortName: "Shibmandir", category: "South Kolkata" },
            { name: "Ballygunge Cultural Association Durga Puja", shortName: "Ballygunge", category: "South Kolkata" ,mustWatch: true },
            { name: "Samaj Sebi Sangha", shortName: "Samaj Sebi", category: "South Kolkata", mustWatch: true },
            { name: "Maddox Square Park", shortName: "Maddox Sq", category: "South Kolkata" },
            { name: "Hindusthan Park Sarbojanin Durgotsab Committee", shortName: "Hindusthan Pk", category: "South Kolkata" ,mustWatch: true },
            { name: "Singhi Park Sarbojanin Durga Puja Committee", shortName: "Singhi Park", category: "South Kolkata" },
            { name: "Ekdalia Evergreen Club", shortName: "Ekdalia", category: "South Kolkata" },
            
            // Jadavpur
            { name: "Jodhpur Park Durga Puja", shortName: "Jodhpur Park", category: "Jadavpur" },
            { name: "Naktala Udayan Sangha", shortName: "Naktala Udayan", category: "Jadavpur" ,mustWatch: true },
            { name: "95 Pally Association", shortName: "95 Pally", category: "Jadavpur" },
            { name: "Babubagan Durgostav", shortName: "Babubagan", category: "Jadavpur" },
            { name: "Kendua Shanti Sangha", shortName: "Kendua", category: "Jadavpur", mustWatch: true },
            { name: "Purbachal Shakti Sangha", shortName: "Purbachal", category: "Jadavpur" ,mustWatch: true },
            { name: "Santoshpur Lake Pally", shortName: "Lake Pally", category: "Jadavpur" , mustWatch: true },
            { name: "Santoshpur Trikon park club ankan potigoti", shortName: "Trikon Park", category: "Jadavpur" },
            { name: "Bosepukur Talbagan Sarbojanin Durga Puja Pandal", shortName: "Bosepukur Talbagan", category: "Jadavpur" },
            { name: "Bosepukur Sitala Madir", shortName: "Bosepukur", category: "Jadavpur" },
            { name: "Pally Mangal Samity Sarbojanin", shortName: "Pally Mangal", category: "Jadavpur", mustWatch: true },
            { name: "Rajdanga Naba Uday Sangha", shortName: "Rajdanga", category: "Jadavpur", mustWatch: true },
            
            // Haridevpur
            { name: "Haridevpur 41 Pally Club", shortName: "Haridevpur 41", category: "Haridevpur" ,mustWatch: true },
            { name: "Ajeya Sanghati Club", shortName: "Ajeya Sanghati", category: "Haridevpur", mustWatch: true },
            { name: "Vivekananda Park Athletic Club Durga Puja Ground", shortName: "Vivekananda", category: "Haridevpur" },
            { name: "Pally Unnayan Samity", shortName: "Pally Unnayan", category: "Haridevpur" },
            
            // Salt Lake & Rajarhat
            { name: "Saltlake AK block", shortName: "AK Block", category: "Salt Lake & Rajarhat" },
            { name: "Saltlake IB Block Durga Puja", shortName: "IB Block", category: "Salt Lake & Rajarhat" },
            { name: "Newtown Sarbojanin Durgotsav", shortName: "Newtown", category: "Salt Lake & Rajarhat", mustWatch: true },

            // Central Kolkata
            { name: "College Square Durga Puja", shortName: "College Sq", category: "Central Kolkata" },
            { name: "Mohammad Ali Park", shortName: "Md Ali Park", category: "Central Kolkata" },
            { name: "Santosh Mitra Square", shortName: "Santosh Mitra", category: "Central Kolkata" , mustWatch: true},
            { name: "Wellington Nagarik Kalyan Samity", shortName: "Wellington", category: "Central Kolkata" },
            { name: "Kankurgachi Jubak Brinda", shortName: "Kankurgachi", category: "Central Kolkata" },
            { name: "Beliaghata 33 Pally", shortName: "Beliaghata 33", category: "Central Kolkata", mustWatch: true },
            
            // West Kolkata & Behala
            { name: "Barisha Club Puja Ground and Community Hall", shortName: "Barisha Club", category: "West Kolkata & Behala",mustWatch: true },
            { name: "Barisha Sarbojonin", shortName: "Barisha", category: "West Kolkata & Behala" },
            { name: "Behala Natundal Durga Puja", shortName: "Natundal", category: "West Kolkata & Behala", mustWatch: true },
            { name: "Behala Friends' Club", shortName: "Behala Friends", category: "West Kolkata & Behala" },
            { name: "Debdaru Fatak Sarbojanin Durgotsav", shortName: "Debdaru Fatak", category: "West Kolkata & Behala" },
            { name: "Thakurpukur State Bank Park", shortName: "SB Park", category: "West Kolkata & Behala", mustWatch: true },
            { name: "Behala Young Men's Association", shortName: "Behala YMA", category: "West Kolkata & Behala" },
            
            // Kidderpore
            { name: "Khidirpur 25 Palli Durga Puja", shortName: "Khidirpur 25", category: "Kidderpore" },
            { name: "Khidderpur Sarbojanin Durgotsab", shortName: "Khidderpur Sarbojanin", category: "Kidderpore" },
            { name: "Khidderpur 74 Pally", shortName: "Khidderpur 74", category: "Kidderpore" },

            // Asian Paints Sharad Shamman Shortlisted
            { name: "To be announced soon", shortName: "TBA", category: "Asian Paints Sharad Shamman Shortlisted" },
        ];

        // --- GLOBAL VARIABLES ---
        let map;
        let userLocation = null;
        let markers = [];
        let directionsService;
        let directionsRenderer;
        let geocoder;
        const GEMINI_API_KEY = 'AIzaSyCR9eO8hbW1x8RCpejMCEh1e_dfBCteaYM';
        let sortedSelectedLocations = [];
        const visitedPandals = new Set();
        let isMapViewActive = false; 
        let calendarInstance = null; // For Flatpickr
        // NEW VARIABLES FOR PARKING
        let carParkingLocation = null;
        let carMarker = null;
        const PARKING_STORAGE_KEY = 'pandalHopperParking';

        // --- INITIALIZATION & UI SETUP ---
        window.initMap = function() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 22.5726, lng: 88.3639 },
                zoom: 11,
                mapTypeControl: false,
                streetViewControl: false,
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
            geocoder = new google.maps.Geocoder();
            
            populateLocationList(); 
            getUserLocation();
            setupEventListeners();
            renderSavedPlans();
            loadParkingLocation();
            initializeCalendar();
        }

        function setupEventListeners() {
            document.getElementById('plan-generator-btn').addEventListener('click', generateHoppingPlan);
            document.getElementById('theme-details-btn').addEventListener('click', getThemeDetails);
            document.getElementById('save-plan-btn').addEventListener('click', showSavePlanModal);
            document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('generic-modal').classList.add('hidden'));
            document.getElementById('generic-modal').addEventListener('click', (e) => {
                if (e.target.id === 'generic-modal') {
                    document.getElementById('generic-modal').classList.add('hidden');
                }
            });
            document.getElementById('manual-location-btn').addEventListener('click', setManualLocation);
            document.getElementById('cancel-save-btn').addEventListener('click', () => {
                document.getElementById('save-plan-modal').classList.add('hidden');
            });
            document.getElementById('confirm-save-btn').addEventListener('click', commitSavePlan);
            document.getElementById('close-share-btn').addEventListener('click', () => {
                document.getElementById('share-plan-modal').classList.add('hidden');
            });
            document.getElementById('copy-share-btn').addEventListener('click', copyShareLink);
            document.getElementById('search-input').addEventListener('keyup', filterPandals);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllSelections);
            document.getElementById('view-toggle-btn').addEventListener('click', toggleMobileView); 
            document.getElementById('weather-forecast-btn').addEventListener('click', () => {
                if (calendarInstance) {
                    calendarInstance.open();
                }
            });
            document.getElementById('car-parking-btn').addEventListener('click', handleParking);
            
            makeDraggable(document.getElementById('floating-buttons-container'));
        }
        
        // UPDATED: Simplified calendar initialization to ensure it's completely hidden
        function initializeCalendar() {
            // The calendar is attached to an already hidden input field.
            // This ensures no visible calendar elements are created on page load.
            calendarInstance = flatpickr("#date-picker", {
                minDate: "2025-09-26",
                maxDate: "2025-10-05", // Main Durga Puja 2025 period
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr, instance) {
                    if (dateStr) {
                        getForecastForDate(dateStr);
                    }
                }
            });
        }

        function populateLocationList(sortedData = null) {
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = ''; 

            if (!sortedData) {
                const categories = {};
                locations.forEach((location, index) => {
                    const category = location.category || "Uncategorized";
                    if (!categories[category]) {
                        categories[category] = [];
                    }
                    categories[category].push({ ...location, originalIndex: index });
                });
                const categoryOrder = ["North Kolkata", "Lake Town / Ultadanga", "Dum Dum", "South Kolkata", "Jadavpur", "Haridevpur", "Salt Lake & Rajarhat", "Central Kolkata", "West Kolkata & Behala", "Kidderpore", "Asian Paints Sharad Shamman Shortlisted"];
                
                sortedData = categoryOrder.map(name => {
                    return {
                        name: name,
                        pandals: categories[name] || []
                    }
                }).filter(cat => cat.pandals.length > 0);
            }
            
            sortedData.forEach((categoryData, catIndex) => {
                const categoryName = categoryData.name;
                const locationsInCategory = categoryData.pandals;

                if (locationsInCategory && locationsInCategory.length > 0) {
                    const detailsEl = document.createElement('details');
                    detailsEl.open = userLocation ? (catIndex === 0) : true;
                    
                    const summaryEl = document.createElement('summary');
                    summaryEl.className = 'text-md font-semibold text-gray-700 cursor-pointer py-2 hover:bg-gray-100 rounded';
                    summaryEl.textContent = categoryName;
                    detailsEl.appendChild(summaryEl);

                    const pandalContainer = document.createElement('div');
                    pandalContainer.className = 'pl-4 border-l-2 border-gray-200';

                    locationsInCategory.forEach(location => {
                        const index = location.originalIndex;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-100 transition-colors';
                        
                        const leftDiv = document.createElement('div');
                        leftDiv.className = 'flex items-center';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `loc-${index}`;
                        checkbox.value = index;
                        checkbox.className = 'h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50';
                        checkbox.disabled = true;
                        if (location.shortName === 'TBA') {
                            checkbox.disabled = true;
                        }
                        checkbox.addEventListener('change', updateMapAndList);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `loc-${index}`;
                        
                        let labelHTML = '';
                        if(location.mustWatch){
                            labelHTML += `* <strong class="text-indigo-600">${location.name}</strong>`;
                        } else {
                            labelHTML += location.name;
                        }

                        if (location.distance !== undefined) {
                            labelHTML += ` <span class="text-xs text-gray-500 font-medium">(${location.distance.toFixed(1)} km)</span>`;
                        }
                        
                        label.innerHTML = labelHTML;
                        label.className = 'ml-3 text-sm text-gray-700';

                        leftDiv.appendChild(checkbox);
                        leftDiv.appendChild(label);
                        itemDiv.appendChild(leftDiv);
                        pandalContainer.appendChild(itemDiv);
                    });

                    detailsEl.appendChild(pandalContainer);
                    listContainer.appendChild(detailsEl);
                }
            });
        }

        function getUserLocation() {
            const statusText = document.getElementById('status-text');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        
                        map.setCenter(userLocation);
                        map.setZoom(13);

                        statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
                        statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
                        statusText.textContent = "Location found! Sorting pandals by distance...";
                        
                        document.getElementById('manual-location-btn').style.display = 'none';
                        document.getElementById('weather-forecast-btn').disabled = false;
                        
                        sortAndDisplayPandalsByDistance().then(() => {
                            statusText.textContent = "Pandals sorted by proximity. Please select.";
                            document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => {
                                if (locations[cb.value].shortName !== 'TBA'){
                                    cb.disabled = false;
                                }
                            });
                            loadPersistedState();
                            loadPlanFromUrl();
                        });
                    },
                    () => handleLocationError(true)
                );
            } else {
                handleLocationError(false);
            }
        }

        function setManualLocation() {
            userLocation = { lat: 22.5679, lng: 88.3526 };
            
            map.setCenter(userLocation);
            map.setZoom(13);

            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
            statusText.textContent = "Location set to Esplanade. Sorting pandals...";
            document.getElementById('manual-location-btn').style.display = 'none';
            document.getElementById('weather-forecast-btn').disabled = false;

            sortAndDisplayPandalsByDistance().then(() => {
                statusText.textContent = "Pandals sorted by proximity. Please select.";
                document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => {
                    if (locations[cb.value].shortName !== 'TBA'){
                        cb.disabled = false;
                    }
                });
                loadPersistedState(); 
                loadPlanFromUrl();
            });
        }
        
        async function sortAndDisplayPandalsByDistance() {
            if (!userLocation) return;

            const statusText = document.getElementById('status-text');
            statusText.textContent = "Calculating distances and sorting pandals...";

            const geocodePromises = locations.map((location, index) => {
                return new Promise((resolve) => {
                    if (location.lat && location.lng) {
                        resolve({ ...location, originalIndex: index });
                        return;
                    }
                    if (location.shortName === 'TBA') {
                        resolve({ ...location, originalIndex: index });
                        return;
                    }
                    geocoder.geocode({ 'address': `${location.name}, Kolkata` }, (results, status) => {
                        if (status === 'OK') {
                            locations[index].lat = results[0].geometry.location.lat();
                            locations[index].lng = results[0].geometry.location.lng();
                            resolve({ ...locations[index], originalIndex: index });
                        } else {
                            console.warn(`Geocode failed for "${location.name}": ${status}`);
                            resolve(null);
                        }
                    });
                });
            });

            const geocodedResults = await Promise.all(geocodePromises);
            const validLocations = geocodedResults.filter(loc => loc && loc.lat);

            const categories = {};
            validLocations.forEach(location => {
                const category = location.category || "Uncategorized";
                if (!categories[category]) {
                    categories[category] = { pandals: [], totalLat: 0, totalLng: 0 };
                }
                const distance = getDistance(userLocation, location);
                location.distance = distance; 

                if (location.originalIndex !== undefined && locations[location.originalIndex]) {
                    locations[location.originalIndex].distance = distance;
                }

                categories[category].pandals.push(location);
                categories[category].totalLat += location.lat;
                categories[category].totalLng += location.lng;
            });

            const sortedCategories = Object.keys(categories).map(categoryName => {
                const categoryData = categories[categoryName];
                const count = categoryData.pandals.length;
                if (count > 0) {
                    const center = { lat: categoryData.totalLat / count, lng: categoryData.totalLng / count };
                    categoryData.distance = getDistance(userLocation, center);
                } else {
                    categoryData.distance = Infinity;
                }
                
                categoryData.pandals.sort((a, b) => a.distance - b.distance);

                return { name: categoryName, ...categoryData };
            });

            sortedCategories.sort((a, b) => a.distance - b.distance);
            
            populateLocationList(sortedCategories);
        }

        async function updateMapAndList() {
            if (!userLocation) return;
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            
            localStorage.setItem('pandalHopperSelected', JSON.stringify(selectedIndices));

            const planButton = document.getElementById('plan-generator-btn');
            const saveButton = document.getElementById('save-plan-btn');
            const themeButton = document.getElementById('theme-details-btn');
            const helperText = document.getElementById('plan-helper-text');
            const statusText = document.getElementById('status-text');

            document.querySelectorAll('#location-list label').forEach(label => {
                const forAttr = label.htmlFor;
                const index = parseInt(forAttr.replace('loc-', ''), 10);
                if (!isNaN(index) && locations[index]) {
                        const location = locations[index];
                        let labelHTML = '';
                        if(location.mustWatch){
                            labelHTML += `* <strong class="text-indigo-600">${location.name}</strong>`;
                        } else {
                            labelHTML += location.name;
                        }
                        if (location.distance !== undefined) {
                            labelHTML += ` <span class="text-xs text-gray-500 font-medium">(${location.distance.toFixed(1)} km)</span>`;
                        }
                        label.innerHTML = labelHTML;
                }
                const itemDiv = label.parentElement.parentElement;
                const existingDoneBtn = itemDiv.querySelector('.done-btn');
                if (existingDoneBtn) {
                    itemDiv.removeChild(existingDoneBtn);
                }
            });

            if (selectedIndices.length < 1 || selectedIndices.length > 6) {
                planButton.disabled = true;
                helperText.textContent = '(Select 1 to 6 pandals for a plan)';
            } else {
                planButton.disabled = false;
                helperText.textContent = `(${selectedIndices.length} selected, ready to plan!)`;
            }

            saveButton.disabled = selectedIndices.length === 0;
            themeButton.disabled = selectedIndices.length === 0;

            const selectedLocationData = selectedIndices.map(index => ({
                ...locations[index],
                originalIndex: parseInt(index, 10)
            }));

            const geocodedLocations = selectedLocationData.filter(loc => loc.lat && loc.lng);
            
            geocodedLocations.sort((a, b) => getDistance(userLocation, a) - getDistance(userLocation, b));
            
            sortedSelectedLocations = geocodedLocations;

            if (selectedIndices.length === 0) {
                clearMarkers();
                sortedSelectedLocations = []; 
                if (userLocation) {
                    map.setCenter(userLocation);
                    map.setZoom(13);
                    const userMarker = new google.maps.Marker({ position: userLocation, map: map, title: 'Your Location', icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }});
                    markers.push(userMarker);
                }
                if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                document.getElementById('navigation-container').classList.add('hidden');
                return;
            }

            statusText.textContent = "Updating map with selected pandals...";
            
            sortedSelectedLocations.forEach((location, index) => {
                const itemDiv = document.getElementById(`loc-${location.originalIndex}`).parentElement.parentElement;
                const label = itemDiv.querySelector('label');
                if (label) {
                    let labelHTML = `${index + 1}. `;
                    if (locations[location.originalIndex].mustWatch) {
                        labelHTML += `* <strong class="text-indigo-600">${location.name}</strong>`;
                    } else {
                        labelHTML += location.name;
                    }
                    if (location.distance !== undefined) {
                        labelHTML += ` <span class="text-xs text-gray-500 font-medium">(${getDistance(userLocation, location).toFixed(1)} km)</span>`;
                    }
                    label.innerHTML = labelHTML;
                }

                const doneBtn = document.createElement('button');
                doneBtn.textContent = 'Done';
                doneBtn.className = 'done-btn text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300';
                
                if (visitedPandals.has(location.originalIndex.toString())) {
                    label.classList.add('line-through', 'text-gray-400');
                    doneBtn.classList.add('bg-green-200');
                }

                doneBtn.onclick = () => {
                    if (visitedPandals.has(location.originalIndex.toString())) {
                        visitedPandals.delete(location.originalIndex.toString());
                        label.classList.remove('line-through', 'text-gray-400');
                        doneBtn.classList.remove('bg-green-200');
                    } else {
                        visitedPandals.add(location.originalIndex.toString());
                        label.classList.add('line-through', 'text-gray-400');
                        doneBtn.classList.add('bg-green-200');
                    }
                    
                    localStorage.setItem('pandalHopperVisited', JSON.stringify(Array.from(visitedPandals)));

                    displaySortedLocationsOnMap(sortedSelectedLocations);
                };

                if (!itemDiv.querySelector('.done-btn')) {
                    itemDiv.appendChild(doneBtn);
                }
            });

            displaySortedLocationsOnMap(sortedSelectedLocations);
            setupNavigationButton(sortedSelectedLocations);
        }

        function displaySortedLocationsOnMap(sortedLocations) {
            clearMarkers();
            directionsRenderer.setDirections({ routes: [] });
            
            const bounds = new google.maps.LatLngBounds();

            if (userLocation) {
                const userMarker = new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    title: 'Your Location',
                    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
                });
                markers.push(userMarker);
                if (sortedLocations.length > 0) {
                    bounds.extend(userLocation);
                }
            }

            sortedLocations.forEach((location, index) => {
                const isVisited = visitedPandals.has(location.originalIndex.toString());
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    label: { text: `${index + 1}. ${location.shortName}`, className: 'gmaps-marker-label' },
                    icon: isVisited ? { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: 'grey', fillOpacity: 0.8, strokeWeight: 0 } : null,
                    title: `${index + 1}. ${location.name}`
                });
                const infowindow = new google.maps.InfoWindow({ content: `<div><strong>${index + 1}. ${location.name}</strong></div>` });
                marker.addListener("click", () => infowindow.open({ anchor: marker, map }));
                markers.push(marker);
                bounds.extend(marker.getPosition());
            });

            const mapContainer = document.getElementById('map-container');
            if (!mapContainer.classList.contains('hidden')) {
                if (!bounds.isEmpty()) {
                    if (markers.length > 1) {
                         map.fitBounds(bounds, 50);
                    } else {
                        map.setCenter(bounds.getCenter());
                        map.setZoom(13);
                    }
                }
            }

            if (sortedLocations.length > 0 && userLocation) {
                const origin = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                const destination = new google.maps.LatLng(sortedLocations[sortedLocations.length - 1].lat, sortedLocations[sortedLocations.length - 1].lng);
                const waypoints = sortedLocations.slice(0, -1).map(loc => ({ location: new google.maps.LatLng(loc.lat, loc.lng), stopover: true }));
                const request = { origin, destination, waypoints, travelMode: google.maps.TravelMode.DRIVING };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        directionsRenderer.setDirections(result);
                    } else {
                        handleDirectionsError(status);
                    }
                });
            }
        }
        
        async function getForecastForDate(selectedDate) {
            if (!userLocation) {
                alert("Please enable your location to get a weather forecast.");
                return;
            }
            
            const displayDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const prompt = `You are a helpful weather assistant. The user is in Kolkata, India, at latitude ${userLocation.lat} and longitude ${userLocation.lng}.
        Provide a 24-hour, hour-by-hour weather forecast for the selected date: ${selectedDate}.

        Your response must be a single HTML \`<div>\` container. Inside this div, for each of the 24 hours of that day (from 00:00 to 23:00), create a child \`<div>\` with the following structure:
        - It must have the classes: 'grid grid-cols-5 items-center gap-2 p-2 border-b text-center'
        - Inside, include these elements in order:
          1. A \`<span>\` with the time in 24-hour format (e.g., "00:00", "01:00", "14:00"). This should have the class 'font-semibold'.
          2. A \`<span>\` with an appropriate weather emoji (e.g., "üåô", "‚òÄÔ∏è", "‚òÅÔ∏è", "üåßÔ∏è").
          3. A \`<span>\` with a brief weather description (e.g., "Clear", "Partly Cloudy"). This span should have the class 'text-left col-span-2'.
          4. A \`<span>\` containing a water drop emoji (üíß) and the percentage chance of rain (e.g., "üíß 15%"). This span should have the class 'text-blue-500 text-sm'.
          5. A \`<strong>\` tag with the temperature in Celsius (e.g., "29¬∞C").

        Do not include any introduction, conclusion, headers, or any other text outside of the main \`<div>\` container. Start directly with the hourly forecast.`;

            await callGeminiAPI(`‚òÅÔ∏è Forecast for ${displayDate}`, prompt);
        }

        async function getThemeDetails() {
            if (sortedSelectedLocations.length === 0) return;
            const prompt = `You are an expert guide for Kolkata's Durga Puja. A user wants to know the theme for the following pandals: ${sortedSelectedLocations.map(p => p.name).join(', ')}.

        For each pandal, use Google Search to find its official theme for Durga Puja 2025, which is happening now.

        Your response must be in both English and Bengali.

        **Output Format:**
        - Do not add any title, introduction, or conclusion.
        - The entire output must be a single HTML \`<ul>\` list.
        - Each pandal should be an \`<li>\` item.
        - Inside each \`<li>\`, use a \`<strong>\` tag for the pandal name.
        - Below the name, provide the theme like this:
          - English Theme: [The theme in English]
          - Bengali Theme: [The theme in Bengali]
        - If no theme information for 2025 is found for a pandal after searching, you must state "Theme for 2025 has not been announced yet." in English, and "‡•®‡•¶‡ß®‡ß´ ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶•‡¶ø‡¶Æ ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ò‡ßã‡¶∑‡¶£‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§" in Bengali.
        - Do not include any information about previous years.`;
            
            await callGeminiAPI("üé® Pandal Theme Details", prompt);
        }

        const generateHoppingPlan = async () => {
            if (sortedSelectedLocations.length < 1 || sortedSelectedLocations.length > 6) return;

            const startLocation = userLocation || { lat: 22.5679, lng: 88.3526 };
            const pandalListString = sortedSelectedLocations.map((p, i) => `${i + 1}. ${p.name}`).join('\n');

            const prompt = `
        You are an expert local travel planner for Kolkata's Durga Puja. A user wants a detailed itinerary to visit the following pandals in a specific, pre-sorted order. The user's journey starts from their current location. The current date is September 24, 2025, during the Durga Puja festival.

        **User's Starting Location:** The user is starting their journey from the GPS coordinates: ${userLocation.lat}, ${userLocation.lng}.

        **Pandals to Visit (in order):**
        ${pandalListString}

        **Your Task:**
        Create a detailed, step-by-step itinerary. 
        1.  **Start Journey:** First, provide public transport directions from the user's current location to the first pandal (${sortedSelectedLocations[0].name}).
        2.  **Pandal Details:** For each pandal, provide nearby restaurant options.
        3.  **Inter-Pandal Travel:** For the travel segments between pandals, provide public transport directions and the estimated travel time.
        4.  **Total Time:** Finally, calculate an overall estimated time for the entire trip.

        **Instructions for the Output:**
        1.  **Structure:** The entire output must be a single HTML structure.
        2.  **Initial Travel:** Start with a section with an \`<h4>\` tag: "<h4>Travel to First Pandal: ${sortedSelectedLocations[0].name}</h4>". Detail the public transport options (metro, bus, auto) and state the **Estimated Travel Time**.
        3.  **For each Pandal:**
            * Create a section for the pandal. Use an \`<h4>\` tag with the pandal's name and its stop number (e.g., "<h4>1. Bagbazar Sarbojanin</h4>").
            * Inside this section, create a sub-section for "Nearby Restaurants". List 2-3 highly-rated restaurant options in an unordered list (\`<ul>\`), mentioning the cuisine type for each.
        4.  **For each Travel Segment (between subsequent pandals):**
            * Create a separate section for the travel instructions. Use an \`<h4>\` tag like "<h4>Travel to next pandal:</h4>".
            * Inside this, detail the public transport options (mentioning metro lines/stations, bus numbers, or auto routes).
            * Clearly state the **Estimated Travel Time** for that segment (e.g., "25-35 minutes").
        5.  **Total Time:** At the very end, provide a "Total Estimated Trip Time". Assume each pandal visit takes approximately 45 minutes and add all the travel times (including the initial journey) to this. Present this in a highlighted box.
        6.  **Language:** Keep the output in simple, clear English.

        **Example HTML structure:**
        <div class="mb-4 border-b pb-4">
            <h4 class="text-lg font-bold">Travel to First Pandal: Pandal Name One</h4>
            <div class="pl-4">
                <p class="mt-2 text-sm">**Route:** [Directions from user's current location...]</p>
                <p class="text-sm"><strong>Estimated Travel Time:</strong> [Time estimate]</p>
            </div>
        </div>
        ... and so on ...
        <div class="mt-6 p-3 bg-blue-100 text-blue-800 rounded-lg">
            <p class="font-bold">Total Estimated Trip Time: [Your calculation here]</p>
        </div>
        `;
            
            await callGeminiAPI("‚ú® Your Pandal Hopping Plan", prompt);
        }

        async function callGeminiAPI(title, prompt) {
            const modal = document.getElementById('generic-modal');
            const loader = document.getElementById('modal-loader');
            const modalText = document.getElementById('modal-text');
            const modalTitle = document.getElementById('modal-title');
            
            modalTitle.textContent = title;
            modal.classList.remove('hidden');
            loader.style.display = 'flex';
            modalText.innerHTML = '';

            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE' || GEMINI_API_KEY === '') {
                modalText.innerHTML = `<p class="text-red-500">Sorry, the Gemini API key has not been set up. Please add the key in the GLOBAL VARIABLES section of the code.</p>`;
                loader.style.display = 'none';
                return;
            }

            
        
	const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }]
            };

            const maxRetries = 4;
            let delay = 1000;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (text) {
                            modalText.innerHTML = text;
                        } else if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                            modalText.innerHTML = `<p class="text-red-500">Sorry, the information could not be retrieved due to safety reasons. Please try selecting different pandals.</p>`;
                        } else {
                            throw new Error("No content received from API.");
                        }
                        loader.style.display = 'none';
                        return;
                    }

                    if ((response.status === 503 || response.status === 429) && attempt < maxRetries - 1) {
                        console.warn(`API is overloaded (status ${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                        continue; 
                    }

                    const errorBody = await response.json().catch(() => ({ error: { message: "Could not parse error response." } }));
                    throw new Error(`API Error: ${response.status} ${response.statusText}. ${errorBody.error?.message || ''}`);

                } catch (error) {
                    console.error(`Gemini API call failed on attempt ${attempt + 1}:`, error);
                    if (attempt === maxRetries - 1) { 
                        modalText.innerHTML = `<p class="text-red-500">Sorry, the server is currently busy. Please try again later. Error: ${error.message}</p>`;
                        loader.style.display = 'none';
                    }
                }
            }
        }

        function showSavePlanModal() {
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            if (selectedIndices.length === 0) {
                return;
            }
            document.getElementById('plan-name-input').value = `My Pujo Plan ${new Date().toLocaleDateString()}`;
            document.getElementById('save-plan-modal').classList.remove('hidden');
        }

        function commitSavePlan() {
            const planNameInput = document.getElementById('plan-name-input');
            const planName = planNameInput.value.trim();
            if (!planName) {
                planNameInput.focus();
                return;
            }

            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const newPlan = {
                name: planName,
                date: new Date().toLocaleDateString(),
                indices: selectedIndices,
                visited: Array.from(visitedPandals)
            };
            plans.push(newPlan);
            localStorage.setItem('pandalPlans', JSON.stringify(plans));
            
            renderSavedPlans();
            document.getElementById('save-plan-modal').classList.add('hidden');
        }

        function renderSavedPlans() {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const listContainer = document.getElementById('saved-plans-list');
            listContainer.innerHTML = ''; 

            if (plans.length === 0) {
                listContainer.innerHTML = `<p class="text-xs text-gray-500 text-center">No plans have been saved yet.</p>`;
                return;
            }

            plans.forEach((plan, index) => {
                const planEl = document.createElement('div');
                planEl.className = 'p-2 border rounded-md bg-gray-50';
                
                planEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-sm">${plan.name}</p>
                            <p class="text-xs text-gray-500">${plan.date}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button class="share-plan-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">Share</button>
                            <button class="load-plan-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Load</button>
                            <button class="delete-plan-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;

                planEl.querySelector('.share-plan-btn').addEventListener('click', () => sharePlan(index));
                planEl.querySelector('.load-plan-btn').addEventListener('click', () => loadPlan(index));
                planEl.querySelector('.delete-plan-btn').addEventListener('click', (event) => deletePlan(index, event));
                
                listContainer.appendChild(planEl);
            });
        }

        function loadPlan(index) {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const plan = plans[index];
            if (!plan) return;

            document.querySelectorAll('#location-list input:checked').forEach(cb => cb.checked = false);
            
            visitedPandals.clear();
            if (plan.visited) {
                plan.visited.forEach(i => visitedPandals.add(i));
            }

            plan.indices.forEach(pandalIndex => {
                const checkbox = document.getElementById(`loc-${pandalIndex}`);
                if (checkbox) checkbox.checked = true;
            });
            updateMapAndList();
        }

        function deletePlan(index, event) {
            const deleteBtn = event.target;
            if (deleteBtn.textContent === 'Delete') {
                deleteBtn.textContent = 'Sure?';
                deleteBtn.classList.replace('bg-red-500', 'bg-yellow-500');
                deleteBtn.classList.replace('hover:bg-red-600', 'hover:bg-yellow-600');
                setTimeout(() => {
                    if (deleteBtn.textContent === 'Sure?') {
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.classList.replace('bg-yellow-500', 'bg-red-500');
                        deleteBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-600');
                    }
                }, 3000); 
            } else {
                const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
                plans.splice(index, 1);
                localStorage.setItem('pandalPlans', JSON.stringify(plans));
                renderSavedPlans();
            }
        }
        
        function sharePlan(index) {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const plan = plans[index];
            if (!plan) return;
            
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?plan=${plan.indices.join(',')}`;
            
            const shareInput = document.getElementById('share-link-input');
            shareInput.value = shareUrl;
            
            document.getElementById('share-plan-modal').classList.remove('hidden');
        }

        function copyShareLink() {
            const shareInput = document.getElementById('share-link-input');
            shareInput.select();
            shareInput.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const copyBtn = document.getElementById('copy-share-btn');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
        
        function loadPlanFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const planIndices = urlParams.get('plan');
            if (planIndices) {
                const indices = planIndices.split(',');
                document.querySelectorAll('#location-list input:checked').forEach(cb => cb.checked = false);
                indices.forEach(index => {
                    const checkbox = document.getElementById(`loc-${index}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateMapAndList();
                window.history.pushState({}, document.title, window.location.pathname);
            }
        }

        function clearAllSelections() {
            document.querySelectorAll('#location-list input:checked').forEach(cb => {
                cb.checked = false;
            });
            visitedPandals.clear();
            
            localStorage.removeItem('pandalHopperSelected');
            localStorage.removeItem('pandalHopperVisited');
            
            updateMapAndList();
        }

        function loadPersistedState() {
            const storedVisited = localStorage.getItem('pandalHopperVisited');
            if (storedVisited) {
                const visitedIndices = JSON.parse(storedVisited);
                visitedIndices.forEach(index => visitedPandals.add(index.toString()));
            }

            const storedSelected = localStorage.getItem('pandalHopperSelected');
            if (storedSelected) {
                const selectedIndices = JSON.parse(storedSelected);
                if (selectedIndices.length > 0) {
                    selectedIndices.forEach(index => {
                        const checkbox = document.getElementById(`loc-${index}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    updateMapAndList();
                }
            }
        }

        function setupNavigationButton(sortedLocations) {
            const navContainer = document.getElementById('navigation-container');
            const navButton = document.getElementById('start-navigation-btn');
            if (!userLocation || sortedLocations.length === 0) {
                navContainer.classList.add('hidden');
                return;
            }
            let mapsUrl = `https://www.google.com/maps/dir/?api=1`;
            mapsUrl += `&origin=${userLocation.lat},${userLocation.lng}`;
            const destination = sortedLocations[sortedLocations.length - 1];
            mapsUrl += `&destination=${destination.lat},${destination.lng}`;
            if (sortedLocations.length > 1) {
                const waypoints = sortedLocations.slice(0, -1).map(loc => `${loc.lat},${loc.lng}`).join('|');
                mapsUrl += `&waypoints=${waypoints}`;
            }
            navButton.onclick = () => window.open(mapsUrl, '_blank');
            navContainer.classList.remove('hidden');
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function handleLocationError(browserHasGeolocation) {
            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-red-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-red-800');
            statusText.textContent = browserHasGeolocation ? 'Please enable location permissions.' : 'Your browser does not support Geolocation.';
            const manualBtn = document.getElementById('manual-location-btn');
            manualBtn.className = "mt-2 font-bold text-indigo-700 underline";
        }
        
        function handleDirectionsError(status) {
            console.warn("Directions request failed due to " + status);
        }
        
        function getDistance(pos1, pos2) {
            const R = 6371;
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 0.5 - Math.cos(dLat)/2 + Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * (1 - Math.cos(dLon))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function filterPandals() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const pandalList = document.getElementById('location-list');
            const categories = pandalList.getElementsByTagName('details');

            for (let category of categories) {
                let hasVisiblePandal = false;
                const pandals = category.querySelectorAll('.flex.items-center.justify-between');

                for (let pandal of pandals) {
                    const label = pandal.querySelector('label');
                    if (label.textContent.toLowerCase().includes(searchTerm)) {
                        pandal.style.display = 'flex';
                        hasVisiblePandal = true;
                    } else {
                        pandal.style.display = 'none';
                    }
                }

                if (hasVisiblePandal) {
                    category.style.display = 'block';
                    category.open = true;
                } else {
                    category.style.display = 'none';
                }
            }
        }
        
        function toggleMobileView() {
            const sidebar = document.getElementById('sidebar');
            const mapContainer = document.getElementById('map-container');
            const viewToggleButton = document.getElementById('view-toggle-btn');

            const mapIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>`;
            const listIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"></line><line x1="8" x2="21" y1="12" y2="12"></line><line x1="8" x2="21" y1="18" y2="18"></line><line x1="3" x2="3.01" y1="6" y2="6"></line><line x1="3" x2="3.01" y1="12" y2="12"></line><line x1="3" x2="3.01" y1="18" y2="18"></line></svg>`;

            isMapViewActive = !isMapViewActive; 

            sidebar.classList.toggle('hidden');
            mapContainer.classList.toggle('hidden');

            if (isMapViewActive) {
                viewToggleButton.innerHTML = listIconSVG;
                google.maps.event.trigger(map, 'resize');
                
                if (sortedSelectedLocations.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    if (userLocation) {
                        bounds.extend(userLocation);
                    }
                    sortedSelectedLocations.forEach(pandal => {
                        bounds.extend({ lat: pandal.lat, lng: pandal.lng });
                    });
                    
                    map.fitBounds(bounds, 50);

                } else if (userLocation) {
                    map.setCenter(userLocation);
                    map.setZoom(13);
                }
            } else {
                viewToggleButton.innerHTML = mapIconSVG;
            }
        }

        // --- NEW PARKING FEATURE FUNCTIONS ---
        function handleParking() {
            if (carParkingLocation) {
                // Car is already parked, so offer options
                if (confirm("You have a parked car. Get directions to it? \n\n(Press 'Cancel' to remove the parking pin instead.)")) {
                    if (!userLocation) {
                        alert("Cannot get your current location to provide directions.");
                        return;
                    }
                    // Open Google Maps for directions
                    const directionsUrl = `https://www.google.com/maps?saddr=${userLocation.lat},${userLocation.lng}&daddr=${carParkingLocation.lat},${carParkingLocation.lng}&travelmode=walking`;
                    window.open(directionsUrl, '_blank');
                } else {
                    // User chose to remove the pin
                    clearParkingLocation();
                }
            } else {
                // No car is parked, so save the current location
                if (!userLocation) {
                    alert("Please enable your location to save your parking spot.");
                    return;
                }
                carParkingLocation = { lat: userLocation.lat, lng: userLocation.lng };
                localStorage.setItem(PARKING_STORAGE_KEY, JSON.stringify(carParkingLocation));
                alert("Parking location saved!");
                updateParkingUI();
            }
        }

        function clearParkingLocation() {
            if (confirm("Are you sure you want to remove your saved parking location?")) {
                carParkingLocation = null;
                localStorage.removeItem(PARKING_STORAGE_KEY);
                alert("Parking location cleared!");
                updateParkingUI();
            }
        }

        function updateParkingUI() {
            const parkBtn = document.getElementById('car-parking-btn');
            const carIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1 .4-1 1v12c0 .6.4 1 1 1h2"/><path d="M5 18h14"/><circle cx="7.5" cy="18.5" r="2.5"/><circle cx="17.5" cy="18.5" r="2.5"/></svg>`;
            const findCarIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m12 8-4 4 4 4"/><path d="M16 12H9"/></svg>`;

            // Remove previous car marker from map
            if (carMarker) {
                carMarker.setMap(null);
                carMarker = null;
            }

            if (carParkingLocation) {
                // Update UI to "Find Car" state
                parkBtn.classList.replace('bg-green-500', 'bg-red-500');
                parkBtn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
                parkBtn.innerHTML = findCarIcon;
                parkBtn.title = "Get directions to car / Clear location";

                // Add a new marker to the map
                carMarker = new google.maps.Marker({
                    position: carParkingLocation,
                    map: map,
                    title: 'My Car',
                    icon: {
                        url: 'https://maps.google.com/mapfiles/kml/shapes/cabs.png',
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    animation: google.maps.Animation.DROP
                });

            } else {
                // Update UI to "Park Car" state
                parkBtn.classList.replace('bg-red-500', 'bg-green-500');
                parkBtn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
                parkBtn.innerHTML = carIcon;
                parkBtn.title = "Save Car Location";
            }
        }

        function loadParkingLocation() {
            const savedLocation = localStorage.getItem(PARKING_STORAGE_KEY);
            if (savedLocation) {
                carParkingLocation = JSON.parse(savedLocation);
            }
            updateParkingUI();
        }

        // --- DRAGGABLE FUNCTIONALITY (CORRECTED) ---
        function makeDraggable(element) {
            let isDown = false;
            let hasDragged = false;
            let offset = [0, 0];

            // Mouse Events
            element.addEventListener('mousedown', (e) => {
                isDown = true;
                hasDragged = false;
                offset = [
                    element.offsetLeft - e.clientX,
                    element.offsetTop - e.clientY
                ];
                element.style.cursor = 'grabbing';
            }, true);

            document.addEventListener('mouseup', (e) => {
                if (isDown) { // Only act if dragging was initiated on our element
                    isDown = false;
                    element.style.cursor = 'move';
                    if (hasDragged) {
                        // This prevents the click event from firing at the end of a drag
                        e.stopPropagation();
                    }
                }
            }, true); // Use capturing to catch the event early

            document.addEventListener('mousemove', (e) => {
                if (isDown) {
                    hasDragged = true;
                    e.preventDefault();
                    
                    let newLeft = e.clientX + offset[0];
                    let newTop = e.clientY + offset[1];

                    // Boundary checks
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const elemWidth = element.offsetWidth;
                    const elemHeight = element.offsetHeight;

                    if (newTop < 0) newTop = 0;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop + elemHeight > viewportHeight) newTop = viewportHeight - elemHeight;
                    if (newLeft + elemWidth > viewportWidth) newLeft = viewportWidth - elemWidth;

                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';
                    element.style.right = 'auto';
                    element.style.bottom = 'auto';
                }
            }, true);

            // Touch Events
            element.addEventListener('touchstart', (e) => {
                isDown = true;
                hasDragged = false;
                const touch = e.touches[0];
                offset = [
                    element.offsetLeft - touch.clientX,
                    element.offsetTop - touch.clientY
                ];
            }, true);

            document.addEventListener('touchend', (e) => {
                if (isDown) {
                    isDown = false;
                    if (hasDragged) {
                        // Prevent click and other actions after a drag on touch devices
                        e.preventDefault();
                        e.stopPropagation();
                    }
                }
            }, true);

            document.addEventListener('touchmove', (e) => {
                if (isDown) {
                    hasDragged = true;
                    e.preventDefault();
                    const touch = e.touches[0];
                    
                    let newLeft = touch.clientX + offset[0];
                    let newTop = touch.clientY + offset[1];

                    // Boundary checks
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const elemWidth = element.offsetWidth;
                    const elemHeight = element.offsetHeight;

                    if (newTop < 0) newTop = 0;
                    if (newLeft < 0) newLeft = 0;
                    if (newTop + elemHeight > viewportHeight) newTop = viewportHeight - elemHeight;
                    if (newLeft + elemWidth > viewportWidth) newLeft = viewportWidth - elemWidth;

                    element.style.left = newLeft + 'px';
                    element.style.top = newTop + 'px';
                    element.style.right = 'auto';
                    element.style.bottom = 'auto';
                }
            }, true);
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBfulQNrZqVY4kj1CCsWoS13SksshKPZM&callback=initMap&libraries=geocoding">
    </script>
</body>
</html>
