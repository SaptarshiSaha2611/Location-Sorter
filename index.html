<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandal Hopper Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #map {
            min-height: 200px; /* Ensure map has a minimum height in flex-col */
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gmaps-marker-label {
            font-size: 12px !important;
            font-weight: bold !important;
            color: black !important; 
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-container" class="flex flex-col md:flex-row h-screen max-h-screen">
        <!-- Sidebar for Controls -->
        <div id="sidebar" class="w-full md:w-2/5 p-2 md:p-4 bg-white shadow-lg flex flex-col h-3/4 md:h-screen transition-all duration-300">
            <div class="flex-shrink-0">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <h1 class="text-xl md:text-2xl font-bold ml-2">Pandal Hopper</h1>
                    </div>
                     <div class="flex items-center space-x-1">
                        <button id="toggle-view-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-1 rounded text-xs">Desktop View</button>
                        <div id="zoom-controls" class="hidden md:flex space-x-1">
                           <button id="zoom-out-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-6 h-6 rounded-full">-</button>
                           <button id="zoom-in-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold w-6 h-6 rounded-full">+</button>
                        </div>
                    </div>
                </div>

                <div id="status" class="p-3 bg-blue-100 text-blue-800 rounded-md text-center">
                    <p id="status-text">Getting your location...</p>
                    <button id="manual-location-btn" class="text-xs text-indigo-600 hover:underline mt-1 font-medium">Wrong location? Set manually</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="grid grid-cols-3 gap-2 mt-4">
                     <button id="theme-details-btn" disabled class="w-full bg-blue-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                        🎨 Theme
                    </button>
                    <button id="plan-generator-btn" disabled class="w-full bg-purple-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-purple-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                        ✨ Plan
                    </button>
                    <button id="save-plan-btn" disabled class="w-full bg-green-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-green-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                        💾 Save
                    </button>
                </div>
                 <p id="plan-helper-text" class="text-xs text-center text-gray-500 mt-1">(Select 2 or more pandals for a plan)</p>


                <div id="navigation-container" class="mt-2 hidden">
                    <button id="start-navigation-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                        Navigate in Google Maps
                    </button>
                </div>
                
                <!-- Saved Plans Section -->
                <div class="mt-4 border-t pt-2">
                    <details>
                        <summary class="font-semibold cursor-pointer text-gray-700">Saved Plans</summary>
                        <div id="saved-plans-list" class="mt-2 max-h-32 overflow-y-auto custom-scrollbar pr-2 space-y-2">
                            <!-- Saved plans will be injected here -->
                        </div>
                    </details>
                </div>

                <h2 class="text-lg font-semibold my-3 border-t pt-3">Select Pandals:</h2>
                 <div class="mb-3">
                    <div class="relative">
                        <input type="search" id="search-input" placeholder="Search for a pandal..." class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <button id="clear-all-btn" class="w-full mt-2 bg-red-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-red-600 transition-colors shadow-md text-sm">Clear Selections</button>
                </div>
            </div>
            
            <div id="location-list" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                <!-- Checkboxes dynamically inserted -->
            </div>
        </div>

        <!-- Map Area -->
        <div id="map-container" class="flex-1 h-1/4 md:h-full w-full md:w-auto">
            <div id="map" class="w-full h-full"></div>
        </div>
    </div>

    <!-- Generic Modal Structure -->
    <div id="generic-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-purple-700"></h2>
            <div id="modal-content" class="min-h-[200px] max-h-[70vh] overflow-y-auto custom-scrollbar">
                <div id="modal-loader" class="flex items-center justify-center h-full">
                    <div class="spinner"></div>
                </div>
                <div id="modal-text" class="text-gray-700 leading-relaxed"></div>
            </div>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div id="save-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 relative">
            <h2 class="text-xl font-bold mb-4">Save Your Plan</h2>
            <p class="text-sm text-gray-600 mb-2">Please enter a name for your plan:</p>
            <input type="text" id="plan-name-input" class="w-full border rounded p-2 mb-4" placeholder="e.g., Saptami Night Out">
            <div class="flex justify-end space-x-2">
                <button id="cancel-save-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirm-save-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save</button>
            </div>
        </div>
    </div>

     <!-- Share Plan Modal -->
    <div id="share-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 p-6 relative">
            <h2 class="text-xl font-bold mb-4">Share Your Plan</h2>
            <p class="text-sm text-gray-600 mb-2">Copy this link and send it to your friends:</p>
            <input type="text" id="share-link-input" class="w-full border rounded p-2 mb-4 bg-gray-100" readonly>
            <div class="flex justify-end space-x-2">
                <button id="close-share-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Close</button>
                <button id="copy-share-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Copy</button>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const locations = [
            // North Kolkata & Lake Town
            { name: "Tala Prattoy Durga Puja Art", shortName: "Tala Prattoy", category: "North Kolkata & Lake Town" },
            { name: "Tala Barowari Durga Puja", shortName: "Tala Barowari", category: "North Kolkata & Lake Town" },
            { name: "Telengabagan durgotsab", shortName: "Telengabagan", category: "North Kolkata & Lake Town" },
            { name: "Dakshinpara Durgotsab Committee", shortName: "Dakshinpara", category: "North Kolkata & Lake Town" },
            { name: "Lake Town Adhibasi Brinda", shortName: "Lake Town", category: "North Kolkata & Lake Town" },
            { name: "Kankurgachi Jubak Brinda", shortName: "Kankurgachi", category: "North Kolkata & Lake Town" },
            { name: "Bagbazar Sarbojanin", shortName: "Bagbazar", category: "North Kolkata & Lake Town" },
            { name: "lalabagan nabankur", shortName: "Lalabagan", category: "North Kolkata & Lake Town" },
            { name: "Maniktala chaltabagan lohapatty", shortName: "Maniktala", category: "North Kolkata & Lake Town" },
            { name: "Jagat Mukherjee Park", shortName: "Jagat M. Park", category: "North Kolkata & Lake Town" },
            { name: "Sovabazar Rajbari", shortName: "Sovabazar", category: "North Kolkata & Lake Town" },
            { name: "Kashi Bose Lane Sarbojanin", shortName: "Kashi Bose Ln", category: "North Kolkata & Lake Town" },
            { name: "Sikdar bagan Sadharan Durgotsab", shortName: "Sikdar Bagan", category: "North Kolkata & Lake Town" },
            { name: "Hatibagan NabinPally Durga Puja", shortName: "NabinPally", category: "North Kolkata & Lake Town" },
            { name: "Hatibagan Sarbojonin", shortName: "Hatibagan", category: "North Kolkata & Lake Town" },
            { name: "Kumartuli Park", shortName: "Kumartuli Park", category: "North Kolkata & Lake Town" },
            { name: "Kumortuli Sarbojonin Durgotsab", shortName: "Kumortuli", category: "North Kolkata & Lake Town" },
            { name: "Simla Byayam Samity", shortName: "Simla Byayam", category: "North Kolkata & Lake Town" },
            { name: "Ahiritola Sarbojanin", shortName: "Ahiritola", category: "North Kolkata & Lake Town" },
            { name: "Pathuriaghata pancher pally", shortName: "Pathuriaghata", category: "North Kolkata & Lake Town" },
            { name: "Chorebagan Sarbojanin", shortName: "Chorebagan", category: "North Kolkata & Lake Town" },
            { name: "Gauri Bari Sarbojanin Durga Puja Pandal", shortName: "Gauri Bari", category: "North Kolkata & Lake Town" },
            // Dum Dum
            { name: "Dakshinpara Durgotsab Committee (Dum Dum)", shortName: "Dakshinpara DD", category: "Dum Dum" },
            { name: "dum dum tarun dal durga puja", shortName: "Tarun Dal", category: "Dum Dum" },
            { name: "Dum Dum Park Sarbojanin Durga Puja Samity", shortName: "DD Park Sarbojanin", category: "Dum Dum" },
            { name: "Dum Dum Park Bharat Chakra", shortName: "DD Park Bharat", category: "Dum Dum" },
            { name: "Dakshindari Youth Forum Ground", shortName: "Dakshindari", category: "Dum Dum" },
            { name: "Aswininagar Bandhumahal Club, Baguiati", shortName: "Aswininagar", category: "Dum Dum" },
            { name: "Arjunpur Amra Sabai Club", shortName: "Arjunpur", category: "Dum Dum" },
            // South Kolkata
            { name: "Haridevpur Ajeya Sanghati", shortName: "Haridevpur", category: "South Kolkata" },
            { name: "Pally Unnayan Samity, Paschim Putiary", shortName: "Pally Unnayan", category: "South Kolkata" },
            { name: "New Alipore Suruchi Sangha", shortName: "Suruchi Sangha", category: "South Kolkata" },
            { name: "Chetla Agrani Club", shortName: "Chetla Agrani", category: "South Kolkata" },
            { name: "Alipore Sarbojanin", shortName: "Alipore", category: "South Kolkata" },
            { name: "Badamtala Ashar Sangha", shortName: "Badamtala", category: "South Kolkata" },
            { name: "Kalighat Milan Sangha", shortName: "Milan Sangha", category: "South Kolkata" },
            { name: "66 Pally Durgapuja Pandal", shortName: "66 Pally", category: "South Kolkata" },
            { name: "Abasar Sarbojanin Durgotsab Samity", shortName: "Abasar", category: "South Kolkata" },
            { name: "Tridhara Sammilani", shortName: "Tridhara", category: "South Kolkata" },
            { name: "Naktala Udayan Sangha", shortName: "Naktala", category: "South Kolkata" },
            { name: "Mudiali Club Durga Puja Pandal", shortName: "Mudiali", category: "South Kolkata" },
            { name: "Shibmandir Sarbojanin Durgotsab Samiti", shortName: "Shibmandir", category: "South Kolkata" },
            { name: "Chakraberia Sarbojanin Durgotsab", shortName: "Chakraberia", category: "South Kolkata" },
            { name: "Vivekananda Park Athletic Club Durga Puja Ground", shortName: "Vivekananda", category: "South Kolkata" },
            { name: "Ballygunge Cultural Association Durga Puja", shortName: "Ballygunge", category: "South Kolkata" },
            { name: "Samaj Sebi Sangha", shortName: "Samaj Sebi", category: "South Kolkata" },
            { name: "Hindusthan Park Sarbojanin Durgotsab Committee", shortName: "Hindusthan Pk", category: "South Kolkata" },
            { name: "Singhi Park Sarbojanin Durga Puja Committee", shortName: "Singhi Park", category: "South Kolkata" },
            { name: "Ekdalia Evergreen Club", shortName: "Ekdalia", category: "South Kolkata" },
            { name: "Jodhpur Park Durga Puja", shortName: "Jodhpur Park", category: "South Kolkata" },
            { name: "95 Pally Association", shortName: "95 Pally", category: "South Kolkata" },
            { name: "Babubagan Durgostav", shortName: "Babubagan", category: "South Kolkata" },
            { name: "Kendua Shanti Sangha", shortName: "Kendua", category: "South Kolkata" },
            { name: "Purbachal Shakti Sangha", shortName: "Purbachal", category: "South Kolkata" },
            { name: "Santoshpur Lake Pally", shortName: "Lake Pally", category: "South Kolkata" },
            { name: "Santoshpur Trikon park club ankan potigoti", shortName: "Trikon Park", category: "South Kolkata" },
            { name: "Bosepukur Sitala Madir", shortName: "Bosepukur", category: "South Kolkata" },
            { name: "Pally Mangal Samity Sarbojanin", shortName: "Pally Mangal", category: "South Kolkata" },
            { name: "Rajdanga Naba Uday Sangha", shortName: "Rajdanga", category: "South Kolkata" },
            // Salt Lake & Rajarhat
            { name: "Saltlake AK block", shortName: "AK Block", category: "Salt Lake & Rajarhat" },
            { name: "Newtown Sarbojanin Durgotsav", shortName: "Newtown", category: "Salt Lake & Rajarhat" },
            { name: "Saltlake IB Block Durga Puja", shortName: "IB Block", category: "Salt Lake & Rajarhat" },
            // Central Kolkata
            { name: "College Square Durga Puja", shortName: "College Sq", category: "Central Kolkata" },
            { name: "Mohammad Ali Park", shortName: "Md Ali Park", category: "Central Kolkata" },
            { name: "Santosh Mitra Square", shortName: "Santosh Mitra", category: "Central Kolkata" },
            { name: "Wellington Nagarik Kalyan Samity", shortName: "Wellington", category: "Central Kolkata" },
            { name: "Beliaghata 33 Pally", shortName: "Beliaghata 33", category: "Central Kolkata" },
            // West Kolkata & Behala
            { name: "Barisha Club Puja Ground and Community Hall", shortName: "Barisha Club", category: "West Kolkata & Behala" },
            { name: "Barisha Sarbojonin", shortName: "Barisha", category: "West Kolkata & Behala" },
            { name: "Behala Natundal Durga Puja", shortName: "Natundal", category: "West Kolkata & Behala" },
            { name: "Thakurpukur State Bank Park", shortName: "SB Park", category: "West Kolkata & Behala" },
            // Asian Paints Shortlisted
            { name: "Shortlisted Pandals (To be announced)", shortName: "TBA", category: "Asian Paints Sharad Shamman" }
        ];

        // --- GLOBAL VARIABLES ---
        let map;
        let userLocation = null;
        let markers = [];
        let directionsService;
        let directionsRenderer;
        let geocoder;
        // *** IMPORTANT: Add your Gemini API Key here ***
        const GEMINI_API_KEY = 'AIzaSyCR9eO8hbW1x8RCpejMCEh1e_dfBCteaYM';
        let sortedSelectedLocations = [];
        const layoutSizes = ['w-1/3', 'w-2/5', 'w-3/5'];
        let currentLayoutIndex = 1;
        let isDesktopView = false; // Start in mobile view by default

        // --- INITIALIZATION & UI SETUP ---
        window.initMap = function() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 22.5726, lng: 88.3639 },
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
            geocoder = new google.maps.Geocoder();
            
            populateLocationList();
            getUserLocation();
            setupEventListeners();
            renderSavedPlans();
            // Check screen size to set initial view
            if (window.innerWidth >= 768) { // md breakpoint in Tailwind
                toggleView(); // Switch to desktop view on larger screens
            }
        }

        function setupEventListeners() {
            document.getElementById('plan-generator-btn').addEventListener('click', generateHoppingPlan);
            document.getElementById('theme-details-btn').addEventListener('click', getThemeDetails);
            document.getElementById('save-plan-btn').addEventListener('click', showSavePlanModal);
            document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('generic-modal').classList.add('hidden'));
            document.getElementById('generic-modal').addEventListener('click', (e) => {
                if (e.target.id === 'generic-modal') {
                    document.getElementById('generic-modal').classList.add('hidden');
                }
            });
            document.getElementById('manual-location-btn').addEventListener('click', setManualLocation);
            // Listeners for the new save modal
            document.getElementById('cancel-save-btn').addEventListener('click', () => {
                document.getElementById('save-plan-modal').classList.add('hidden');
            });
            document.getElementById('confirm-save-btn').addEventListener('click', commitSavePlan);
             // Listeners for the share modal
            document.getElementById('close-share-btn').addEventListener('click', () => {
                document.getElementById('share-plan-modal').classList.add('hidden');
            });
            document.getElementById('copy-share-btn').addEventListener('click', copyShareLink);
            // Listeners for layout buttons
            document.getElementById('toggle-view-btn').addEventListener('click', toggleView);
            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                if (currentLayoutIndex < layoutSizes.length - 1) {
                    currentLayoutIndex++;
                    updateDesktopLayout();
                }
            });
            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                 if (currentLayoutIndex > 0) {
                    currentLayoutIndex--;
                    updateDesktopLayout();
                }
            });
            document.getElementById('search-input').addEventListener('keyup', filterPandals);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllSelections);
        }

        function toggleView() {
            isDesktopView = !isDesktopView;
            const mainContainer = document.getElementById('main-container');
            const sidebar = document.getElementById('sidebar');
            const mapContainer = document.getElementById('map-container');
            const toggleBtn = document.getElementById('toggle-view-btn');
            const zoomControls = document.getElementById('zoom-controls');

            if (isDesktopView) {
                // Switch to Desktop View
                mainContainer.classList.remove('flex-col');
                mainContainer.classList.add('flex-row');

                sidebar.classList.remove('w-full', 'h-2/3');
                sidebar.classList.add('md:w-2/5'); // Apply a default desktop width
                updateDesktopLayout(); // Apply the specific zoom level width

                mapContainer.classList.remove('h-1/3', 'w-full');
                mapContainer.classList.add('flex-1');
                
                toggleBtn.textContent = 'Mobile View';
                zoomControls.classList.remove('hidden');
                zoomControls.classList.add('md:flex');
            } else {
                // Switch to Mobile View
                mainContainer.classList.remove('flex-row');
                mainContainer.classList.add('flex-col');

                layoutSizes.forEach(size => sidebar.classList.remove(size));
                sidebar.classList.add('w-full', 'h-2/3');
                
                mapContainer.classList.remove('flex-1');
                mapContainer.classList.add('h-1/3', 'w-full');

                toggleBtn.textContent = 'Desktop View';
                zoomControls.classList.add('hidden');
            }
             setTimeout(() => {
                 if (map) google.maps.event.trigger(map, 'resize');
            }, 300);
        }

        function updateDesktopLayout() {
            if (!isDesktopView) return;
            const sidebar = document.getElementById('sidebar');
            layoutSizes.forEach(sizeClass => sidebar.classList.remove(sizeClass));
            sidebar.classList.add(layoutSizes[currentLayoutIndex]);

            document.getElementById('zoom-in-btn').disabled = currentLayoutIndex === layoutSizes.length - 1;
            document.getElementById('zoom-out-btn').disabled = currentLayoutIndex === 0;

            setTimeout(() => {
                 if (map) google.maps.event.trigger(map, 'resize');
            }, 300);
        }
        
        // --- Populate location list function with collapsible sections ---
        function populateLocationList() {
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            const categories = {};
            locations.forEach((location, index) => {
                const category = location.category || "Uncategorized";
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push({ ...location, originalIndex: index });
            });
            const categoryOrder = ["North Kolkata & Lake Town", "Dum Dum", "South Kolkata", "Salt Lake & Rajarhat", "Central Kolkata", "West Kolkata & Behala", "Asian Paints Sharad Shamman"];
            categoryOrder.forEach(categoryName => {
                const locationsInCategory = categories[categoryName];
                if (locationsInCategory && locationsInCategory.length > 0) {
                    const detailsEl = document.createElement('details');
                    detailsEl.open = true; // Categories are open by default
                    
                    const summaryEl = document.createElement('summary');
                    summaryEl.className = 'text-md font-semibold text-gray-700 cursor-pointer py-2 hover:bg-gray-100 rounded';
                    summaryEl.textContent = categoryName;
                    detailsEl.appendChild(summaryEl);

                    const pandalContainer = document.createElement('div');
                    pandalContainer.className = 'pl-4 border-l-2 border-gray-200';

                    locationsInCategory.forEach(location => {
                        const index = location.originalIndex;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center p-2 rounded-md hover:bg-gray-100 transition-colors';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `loc-${index}`;
                        checkbox.value = index;
                        checkbox.className = 'h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50';
                        checkbox.disabled = true;
                        if (location.shortName === 'TBA') {
                            checkbox.disabled = true;
                        }
                        checkbox.addEventListener('change', updateMapAndList);
                        const label = document.createElement('label');
                        label.htmlFor = `loc-${index}`;
                        label.textContent = location.name;
                        label.className = 'ml-3 text-sm text-gray-700';
                        itemDiv.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        pandalContainer.appendChild(itemDiv);
                    });

                    detailsEl.appendChild(pandalContainer);
                    listContainer.appendChild(detailsEl);
                }
            });
        }


        // --- CORE LOGIC ---
        function getUserLocation() {
            const statusText = document.getElementById('status-text');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
                        statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
                        statusText.textContent = "Location found! Please select pandals.";
                        document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => {
                            if (cb.value !== (locations.length - 1).toString()){ // Enable all except the TBA one
                                cb.disabled = false;
                            }
                        });
                        document.getElementById('manual-location-btn').style.display = 'none';
                        loadPlanFromUrl(); // Check for shared plan after getting location
                    },
                    () => handleLocationError(true)
                );
            } else {
                handleLocationError(false);
            }
        }

        function setManualLocation() {
            userLocation = { lat: 22.5679, lng: 88.3526 }; // Esplanade, Kolkata
            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
            statusText.textContent = "Location manually set to Esplanade.";
            document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => {
                 if (cb.value !== (locations.length - 1).toString()){
                    cb.disabled = false;
                }
            });
            document.getElementById('manual-location-btn').style.display = 'none';
            loadPlanFromUrl(); // Check for shared plan after setting manual location
        }

        async function updateMapAndList() {
            if (!userLocation) return;
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            const planButton = document.getElementById('plan-generator-btn');
            const saveButton = document.getElementById('save-plan-btn');
            const themeButton = document.getElementById('theme-details-btn');
            const helperText = document.getElementById('plan-helper-text');
            const statusText = document.getElementById('status-text');

            // Reset all labels to their original names first
            document.querySelectorAll('#location-list label').forEach(label => {
                const forAttr = label.htmlFor;
                const index = parseInt(forAttr.replace('loc-', ''), 10);
                if (!isNaN(index) && locations[index]) {
                    label.textContent = locations[index].name;
                }
            });

            if (selectedIndices.length < 2) {
                 planButton.disabled = true;
                 helperText.style.display = 'block';
            } else {
                 planButton.disabled = false;
                 helperText.style.display = 'none';
            }

            saveButton.disabled = selectedIndices.length === 0;
            themeButton.disabled = selectedIndices.length === 0;


            if (selectedIndices.length === 0) {
                clearMarkers();
                if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                document.getElementById('navigation-container').classList.add('hidden');
                return;
            }

            statusText.textContent = "Finding pandal locations...";
            
            const selectedLocationData = selectedIndices.map(index => ({
                ...locations[index],
                originalIndex: parseInt(index, 10)
            }));

            const geocodePromises = selectedLocationData.map(location => {
                return new Promise((resolve, reject) => {
                    if (location.lat && location.lng) {
                        resolve(location);
                        return;
                    }
                    geocoder.geocode({ 'address': `${location.name}, Kolkata` }, (results, status) => {
                        if (status === 'OK') {
                            const newLocation = {
                                ...location,
                                lat: results[0].geometry.location.lat(),
                                lng: results[0].geometry.location.lng()
                            };
                            resolve(newLocation);
                        } else {
                            console.error(`Geocode was not successful for "${location.name}": ${status}`);
                            reject(location.name);
                        }
                    });
                });
            });

            const results = await Promise.allSettled(geocodePromises);
            const geocodedLocations = [];
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    geocodedLocations.push(result.value);
                } else {
                    console.warn(`Could not find location for: ${result.reason}`);
                }
            });

            if(geocodedLocations.length === 0) {
                statusText.textContent = "No pandals could be found.";
                return;
            }

            statusText.textContent = `Showing ${geocodedLocations.length} pandals on the map.`;


            geocodedLocations.forEach(location => {
                location.distance = getDistance(userLocation, location);
            });
            geocodedLocations.sort((a, b) => a.distance - b.distance);
            
            sortedSelectedLocations = geocodedLocations;
            
            // Update labels with sorted numbers
            sortedSelectedLocations.forEach((location, index) => {
                const label = document.querySelector(`label[for="loc-${location.originalIndex}"]`);
                if (label) {
                    label.textContent = `${index + 1}. ${location.name}`;
                }
            });

            displaySortedLocationsOnMap(geocodedLocations);
            setupNavigationButton(geocodedLocations);
        }

        function displaySortedLocationsOnMap(sortedLocations) {
            clearMarkers();
            directionsRenderer.setDirections({ routes: [] });
            const bounds = new google.maps.LatLngBounds();

            const userMarker = new google.maps.Marker({
                position: userLocation, map: map, title: 'Your Location',
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
            });
            markers.push(userMarker);
            bounds.extend(userLocation);

            sortedLocations.forEach((location, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng }, 
                    map: map,
                    label: {
                        text: `${index + 1}. ${location.shortName}`,
                        className: 'gmaps-marker-label'
                    },
                    title: `${index + 1}. ${location.name} (${location.distance.toFixed(2)} km away)`
                });
                const infowindow = new google.maps.InfoWindow({ content: `<div><strong>${index + 1}. ${location.name}</strong><br>${location.distance.toFixed(2)} km away</div>` });
                marker.addListener("click", () => infowindow.open({ anchor: marker, map }));
                markers.push(marker);
                bounds.extend(marker.getPosition());
            });

            map.fitBounds(bounds);

            if (sortedLocations.length > 0) {
                const origin = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                const destination = new google.maps.LatLng(sortedLocations[sortedLocations.length - 1].lat, sortedLocations[sortedLocations.length - 1].lng);
                const waypoints = sortedLocations.slice(0, -1).map(loc => ({ location: new google.maps.LatLng(loc.lat, loc.lng), stopover: true }));
                const request = { origin, destination, waypoints, travelMode: google.maps.TravelMode.DRIVING };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        directionsRenderer.setDirections(result);
                    } else {
                        handleDirectionsError(status);
                    }
                });
            }
        }
        
        // --- GEMINI API INTEGRATION ---
        async function getThemeDetails() {
            if (sortedSelectedLocations.length === 0) return;
            const prompt = `You are an expert guide for Kolkata's Durga Puja. A user wants to know the theme for the following pandals: ${sortedSelectedLocations.map(p => p.name).join(', ')}.

For each pandal, use Google Search to find its official theme for Durga Puja 2025.

Your response must be in both English and Bengali.

**Output Format:**
- Do not add any title, introduction, or conclusion.
- The entire output must be a single HTML \`<ul>\` list.
- Each pandal should be an \`<li>\` item.
- Inside each \`<li>\`, use a \`<strong>\` tag for the pandal name.
- Below the name, provide the theme like this:
  - English Theme: [The theme in English]
  - Bengali Theme: [The theme in Bengali]
- If no theme information for 2025 is found for a pandal after searching, you must state "Theme for 2025 has not been announced yet." in English, and "२०২৫ সালের থিম এখনও ঘোষণা করা হয়নি।" in Bengali.
- Do not include any information about previous years.`;
            
            await callGeminiAPI("🎨 Pandal Theme Details", prompt);
        }


        async function generateHoppingPlan() {
            if (sortedSelectedLocations.length < 2) return;
            const prompt = `You are an expert local guide for Kolkata's Durga Puja. A user wants a detailed plan to visit: ${sortedSelectedLocations.map(p => p.name).join(', ')}.

For each pandal in the list, perform a comprehensive Google Search to gather the following critical information in this specific order:

1.  **Nearby Restaurants (3 Options):**
    * Find three different, highly-rated restaurants within walking distance.
    * For each restaurant, provide its name and cuisine type (e.g., Bengali, Mughlai, Cafe).

2.  **Parking Information (Very Detailed):**
    * Search for parking arrangements near "[Pandal Name] Durga Puja" for both the previous year and any available real-time information.
    * Describe the typical parking situation (e.g., designated parking lot, street parking on specific roads).
    * Provide a Google Maps URL to search for parking. The URL must be in this format: \`https://www.google.com/maps/search/?api=1&query=Parking+near+[Pandal Name],+Kolkata\`.

**Output Format:**
-   Do not add any title, introduction, or conclusion.
-   The entire output must be a single HTML \`<ul>\` list.
-   Each pandal should be an \`<li>\` item.
-   Inside each \`<li>\`, use a \`<strong>\` tag for the pandal name.
-   Use nested \`<ul>\` lists, showing "Restaurants" first, and then "Parking Details".
-   Parking URLs must be clickable \`<a href="..." target="_blank">\` links.
-   At the very end, outside the main list, add a small \`<p>\` with a disclaimer: "Parking information is based on past data and the latest available search results and can change. Please verify on-site."`;
            
            await callGeminiAPI("✨ Your Pandal Hopping Plan", prompt);
        }

        async function callGeminiAPI(title, prompt) {
            const modal = document.getElementById('generic-modal');
            const loader = document.getElementById('modal-loader');
            const modalText = document.getElementById('modal-text');
            const modalTitle = document.getElementById('modal-title');
            
            modalTitle.textContent = title;
            modal.classList.remove('hidden');
            loader.style.display = 'flex';
            modalText.innerHTML = '';

            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                modalText.innerHTML = `<p class="text-red-500">Sorry, the Gemini API key has not been set up. Please add the key in the GLOBAL VARIABLES section of the code.</p>`;
                loader.style.display = 'none';
                return;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }]
            };

            const maxRetries = 4;
            let delay = 1000; // 1 second

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        
                        if (text) {
                            modalText.innerHTML = text;
                        } else if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                            modalText.innerHTML = `<p class="text-red-500">Sorry, the information could not be retrieved due to safety reasons. Please try selecting different pandals.</p>`;
                        } else {
                            throw new Error("No content received from API.");
                        }
                        loader.style.display = 'none';
                        return; // Success, exit the function
                    }

                    if ((response.status === 503 || response.status === 429) && attempt < maxRetries - 1) {
                        console.warn(`API is overloaded (status ${response.status}). Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                        continue; 
                    }

                    const errorBody = await response.json().catch(() => ({ error: { message: "Could not parse error response." } }));
                    throw new Error(`API Error: ${response.status} ${response.statusText}. ${errorBody.error?.message || ''}`);

                } catch (error) {
                    console.error(`Gemini API call failed on attempt ${attempt + 1}:`, error);
                    if (attempt === maxRetries - 1) { 
                        modalText.innerHTML = `<p class="text-red-500">Sorry, the server is currently busy. Please try again later. Error: ${error.message}</p>`;
                        loader.style.display = 'none';
                    }
                }
            }
        }


        // --- SAVE/LOAD/SHARE PLAN LOGIC ---
        function showSavePlanModal() {
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            if (selectedIndices.length === 0) {
                return;
            }
            document.getElementById('plan-name-input').value = `My Pujo Plan ${new Date().toLocaleDateString()}`;
            document.getElementById('save-plan-modal').classList.remove('hidden');
        }

        function commitSavePlan() {
            const planNameInput = document.getElementById('plan-name-input');
            const planName = planNameInput.value.trim();
            if (!planName) {
                planNameInput.focus();
                return;
            }

            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const newPlan = {
                name: planName,
                date: new Date().toLocaleDateString(),
                indices: selectedIndices
            };
            plans.push(newPlan);
            localStorage.setItem('pandalPlans', JSON.stringify(plans));
            
            renderSavedPlans();
            document.getElementById('save-plan-modal').classList.add('hidden');
        }

        function renderSavedPlans() {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const listContainer = document.getElementById('saved-plans-list');
            listContainer.innerHTML = ''; 

            if (plans.length === 0) {
                listContainer.innerHTML = `<p class="text-xs text-gray-500 text-center">No plans have been saved yet.</p>`;
                return;
            }

            plans.forEach((plan, index) => {
                const planEl = document.createElement('div');
                planEl.className = 'p-2 border rounded-md bg-gray-50';
                
                planEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-sm">${plan.name}</p>
                            <p class="text-xs text-gray-500">${plan.date}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button class="share-plan-btn text-xs bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600">Share</button>
                            <button class="load-plan-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Load</button>
                            <button class="delete-plan-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;

                planEl.querySelector('.share-plan-btn').addEventListener('click', () => sharePlan(index));
                planEl.querySelector('.load-plan-btn').addEventListener('click', () => loadPlan(index));
                planEl.querySelector('.delete-plan-btn').addEventListener('click', (event) => deletePlan(index, event));
                
                listContainer.appendChild(planEl);
            });
        }

        function loadPlan(index) {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const plan = plans[index];
            if (!plan) return;

            document.querySelectorAll('#location-list input:checked').forEach(cb => cb.checked = false);

            plan.indices.forEach(pandalIndex => {
                const checkbox = document.getElementById(`loc-${pandalIndex}`);
                if (checkbox) checkbox.checked = true;
            });
            updateMapAndList();
        }

        function deletePlan(index, event) {
            const deleteBtn = event.target;
            if (deleteBtn.textContent === 'Delete') {
                deleteBtn.textContent = 'Sure?';
                deleteBtn.classList.replace('bg-red-500', 'bg-yellow-500');
                deleteBtn.classList.replace('hover:bg-red-600', 'hover:bg-yellow-600');
                setTimeout(() => {
                    if (deleteBtn.textContent === 'Sure?') {
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.classList.replace('bg-yellow-500', 'bg-red-500');
                        deleteBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-600');
                    }
                }, 3000); 
            } else {
                const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
                plans.splice(index, 1);
                localStorage.setItem('pandalPlans', JSON.stringify(plans));
                renderSavedPlans();
            }
        }
        
        function sharePlan(index) {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const plan = plans[index];
            if (!plan) return;
            
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?plan=${plan.indices.join(',')}`;
            
            const shareInput = document.getElementById('share-link-input');
            shareInput.value = shareUrl;
            
            document.getElementById('share-plan-modal').classList.remove('hidden');
        }

        function copyShareLink() {
            const shareInput = document.getElementById('share-link-input');
            shareInput.select();
            shareInput.setSelectionRange(0, 99999); // For mobile devices
            try {
                document.execCommand('copy');
                const copyBtn = document.getElementById('copy-share-btn');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
        
        function loadPlanFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const planIndices = urlParams.get('plan');
            if (planIndices) {
                const indices = planIndices.split(',');
                document.querySelectorAll('#location-list input:checked').forEach(cb => cb.checked = false);
                indices.forEach(index => {
                    const checkbox = document.getElementById(`loc-${index}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateMapAndList();

                // Clean the URL
                window.history.pushState({}, document.title, window.location.pathname);
            }
        }

        function clearAllSelections() {
            document.querySelectorAll('#location-list input:checked').forEach(cb => {
                cb.checked = false;
            });
            updateMapAndList();
        }


        // --- UTILITY & ERROR HANDLING ---
        function setupNavigationButton(sortedLocations) {
            const navContainer = document.getElementById('navigation-container');
            const navButton = document.getElementById('start-navigation-btn');
            if (!userLocation || sortedLocations.length === 0) {
                navContainer.classList.add('hidden');
                return;
            }
            let mapsUrl = `https://www.google.com/maps/dir/?api=1`;
            mapsUrl += `&origin=${userLocation.lat},${userLocation.lng}`;
            const destination = sortedLocations[sortedLocations.length - 1];
            mapsUrl += `&destination=${destination.lat},${destination.lng}`;
            if (sortedLocations.length > 1) {
                const waypoints = sortedLocations.slice(0, -1).map(loc => `${loc.lat},${loc.lng}`).join('|');
                mapsUrl += `&waypoints=${waypoints}`;
            }
            navButton.onclick = () => window.open(mapsUrl, '_blank');
            navContainer.classList.remove('hidden');
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function handleLocationError(browserHasGeolocation) {
            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-red-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-red-800');
            statusText.textContent = browserHasGeolocation ? 'Please enable location permissions.' : 'Your browser does not support Geolocation.';
            const manualBtn = document.getElementById('manual-location-btn');
            manualBtn.className = "mt-2 font-bold text-indigo-700 underline";
        }
        
        function handleDirectionsError(status) {
            console.warn("Directions request failed due to " + status);
        }
        
        function getDistance(pos1, pos2) {
            const R = 6371;
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 0.5 - Math.cos(dLat)/2 + Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * (1 - Math.cos(dLon))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function filterPandals() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const pandalList = document.getElementById('location-list');
            const categories = pandalList.getElementsByTagName('details');

            for (let category of categories) {
                let hasVisiblePandal = false;
                const pandals = category.querySelectorAll('.flex.items-center');

                for (let pandal of pandals) {
                    const label = pandal.querySelector('label');
                    if (label.textContent.toLowerCase().includes(searchTerm)) {
                        pandal.style.display = 'flex';
                        hasVisiblePandal = true;
                    } else {
                        pandal.style.display = 'none';
                    }
                }

                if (hasVisiblePandal) {
                    category.style.display = 'block';
                    category.open = true;
                } else {
                    category.style.display = 'none';
                }
            }
        }

    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBfulQNrZqVY4kj1CCsWoS13SksshKPZM&callback=initMap&libraries=geocoding">
    </script>
</body>
</html>

