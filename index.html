<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandal Hopper Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        #map {
            min-height: 400px;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for smaller marker labels */
        .gmaps-marker-label {
            font-size: 10px !important;
            font-weight: bold !important;
            color: black !important; /* Changed from white to black for visibility */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col md:flex-row h-screen max-h-screen">
        <!-- Sidebar for Controls -->
        <div class="w-full md:w-1/3 lg:w-1/4 p-4 bg-white shadow-lg flex flex-col max-h-screen">
            <div class="flex-shrink-0">
                <div class="flex items-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    <h1 class="text-2xl font-bold ml-3">Pandal Hopper</h1>
                </div>

                <div id="status" class="p-3 bg-blue-100 text-blue-800 rounded-md text-center">
                    <p id="status-text">Apnar location neoa hochche...</p>
                    <button id="manual-location-btn" class="text-xs text-indigo-600 hover:underline mt-1 font-medium">Location thik nei? Manual set korun</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button id="plan-generator-btn" disabled class="w-full bg-purple-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-purple-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                        âœ¨ Plan Toiri
                    </button>
                    <button id="save-plan-btn" disabled class="w-full bg-green-600 text-white font-bold py-2 px-2 rounded-lg hover:bg-green-700 transition-colors shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center text-sm">
                        ðŸ’¾ Save Plan
                    </button>
                </div>
                 <p id="plan-helper-text" class="text-xs text-center text-gray-500 mt-1">(Duti ba tar beshi pandal select korun)</p>


                <div id="navigation-container" class="mt-2 hidden">
                    <button id="start-navigation-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                        Google Maps e Navigation
                    </button>
                </div>
                
                <!-- Saved Plans Section -->
                <div class="mt-4 border-t pt-2">
                    <details>
                        <summary class="font-semibold cursor-pointer text-gray-700">Saved Plans</summary>
                        <div id="saved-plans-list" class="mt-2 max-h-32 overflow-y-auto custom-scrollbar pr-2 space-y-2">
                            <!-- Saved plans will be injected here -->
                        </div>
                    </details>
                </div>

                <h2 class="text-lg font-semibold my-3 border-t pt-3">Pandalguli select korun:</h2>
            </div>
            
            <div id="location-list" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                <!-- Checkboxes dynamically inserted -->
            </div>
        </div>

        <!-- Map Area -->
        <div class="flex-1 h-full">
            <div id="map" class="w-full h-full"></div>
        </div>
    </div>

    <!-- Gemini Plan Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 p-6 relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-purple-700">âœ¨ Apnar Pandal Hopping Plan</h2>
            <div id="modal-content" class="min-h-[200px] max-h-[70vh] overflow-y-auto">
                <div id="modal-loader" class="flex items-center justify-center h-full">
                    <div class="spinner"></div>
                </div>
                <div id="modal-plan-text" class="text-gray-700 leading-relaxed"></div>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        const locations = [
            // North Kolkata & Lake Town
            { name: "Tala Prattoy Durga Puja Art", shortName: "Tala Prattoy", category: "North Kolkata & Lake Town" },
            { name: "Tala Barowari Durga Puja", shortName: "Tala Barowari", category: "North Kolkata & Lake Town" },
            { name: "Telengabagan durgotsab", shortName: "Telengabagan", category: "North Kolkata & Lake Town" },
            { name: "Dakshinpara Durgotsab Committee", shortName: "Dakshinpara", category: "North Kolkata & Lake Town" },
            { name: "Lake Town Adhibasi Brinda", shortName: "Lake Town", category: "North Kolkata & Lake Town" },
            { name: "Kankurgachi Jubak Brinda", shortName: "Kankurgachi", category: "North Kolkata & Lake Town" },
            { name: "Bagbazar Sarbojanin", shortName: "Bagbazar", category: "North Kolkata & Lake Town" },
            { name: "lalabagan nabankur", shortName: "Lalabagan", category: "North Kolkata & Lake Town" },
            { name: "Maniktala chaltabagan lohapatty", shortName: "Maniktala", category: "North Kolkata & Lake Town" },
            { name: "Jagat Mukherjee Park", shortName: "Jagat M. Park", category: "North Kolkata & Lake Town" },
            { name: "Sovabazar Rajbari", shortName: "Sovabazar", category: "North Kolkata & Lake Town" },
            { name: "Kashi Bose Lane Sarbojanin", shortName: "Kashi Bose Ln", category: "North Kolkata & Lake Town" },
            { name: "Sikdar bagan Sadharan Durgotsab", shortName: "Sikdar Bagan", category: "North Kolkata & Lake Town" },
            { name: "Hatibagan NabinPally Durga Puja", shortName: "NabinPally", category: "North Kolkata & Lake Town" },
            { name: "Hatibagan Sarbojonin", shortName: "Hatibagan", category: "North Kolkata & Lake Town" },
            { name: "Kumartuli Park", shortName: "Kumartuli Park", category: "North Kolkata & Lake Town" },
            { name: "Kumortuli Sarbojonin Durgotsab", shortName: "Kumortuli", category: "North Kolkata & Lake Town" },
            { name: "Simla Byayam Samity", shortName: "Simla Byayam", category: "North Kolkata & Lake Town" },
            { name: "Ahiritola Sarbojanin", shortName: "Ahiritola", category: "North Kolkata & Lake Town" },
            { name: "Pathuriaghata pancher pally", shortName: "Pathuriaghata", category: "North Kolkata & Lake Town" },
            { name: "Chorebagan Sarbojanin", shortName: "Chorebagan", category: "North Kolkata & Lake Town" },
            { name: "Gauri Bari Sarbojanin Durga Puja Pandal", shortName: "Gauri Bari", category: "North Kolkata & Lake Town" },
            // Dum Dum
            { name: "Dakshinpara Durgotsab Committee (Dum Dum)", shortName: "Dakshinpara DD", category: "Dum Dum" },
            { name: "dum dum tarun dal durga puja", shortName: "Tarun Dal", category: "Dum Dum" },
            { name: "Dum Dum Park Sarbojanin Durga Puja Samity", shortName: "DD Park Sarbojanin", category: "Dum Dum" },
            { name: "Dum Dum Park Bharat Chakra", shortName: "DD Park Bharat", category: "Dum Dum" },
            { name: "Dakshindari Youth Forum Ground", shortName: "Dakshindari", category: "Dum Dum" },
            { name: "Aswininagar Bandhumahal Club, Baguiati", shortName: "Aswininagar", category: "Dum Dum" },
            { name: "Arjunpur Amra Sabai Club", shortName: "Arjunpur", category: "Dum Dum" },
            // South Kolkata
            { name: "Haridevpur Ajeya Sanghati", shortName: "Haridevpur", category: "South Kolkata" },
            { name: "Pally Unnayan Samity, Paschim Putiary", shortName: "Pally Unnayan", category: "South Kolkata" },
            { name: "New Alipore Suruchi Sangha", shortName: "Suruchi Sangha", category: "South Kolkata" },
            { name: "Chetla Agrani Club", shortName: "Chetla Agrani", category: "South Kolkata" },
            { name: "Alipore Sarbojanin", shortName: "Alipore", category: "South Kolkata" },
            { name: "Badamtala Ashar Sangha", shortName: "Badamtala", category: "South Kolkata" },
            { name: "Kalighat Milan Sangha", shortName: "Milan Sangha", category: "South Kolkata" },
            { name: "66 Pally Durgapuja Pandal", shortName: "66 Pally", category: "South Kolkata" },
            { name: "Abasar Sarbojanin Durgotsab Samity", shortName: "Abasar", category: "South Kolkata" },
            { name: "Tridhara Sammilani", shortName: "Tridhara", category: "South Kolkata" },
            { name: "Naktala Udayan Sangha", shortName: "Naktala", category: "South Kolkata" },
            { name: "Mudiali Club Durga Puja Pandal", shortName: "Mudiali", category: "South Kolkata" },
            { name: "Shibmandir Sarbojanin Durgotsab Samiti", shortName: "Shibmandir", category: "South Kolkata" },
            { name: "Chakraberia Sarbojanin Durgotsab", shortName: "Chakraberia", category: "South Kolkata" },
            { name: "Vivekananda Park Athletic Club Durga Puja Ground", shortName: "Vivekananda", category: "South Kolkata" },
            { name: "Ballygunge Cultural Association Durga Puja", shortName: "Ballygunge", category: "South Kolkata" },
            { name: "Samaj Sebi Sangha", shortName: "Samaj Sebi", category: "South Kolkata" },
            { name: "Hindusthan Park Sarbojanin Durgotsab Committee", shortName: "Hindusthan Pk", category: "South Kolkata" },
            { name: "Singhi Park Sarbojanin Durga Puja Committee", shortName: "Singhi Park", category: "South Kolkata" },
            { name: "Ekdalia Evergreen Club", shortName: "Ekdalia", category: "South Kolkata" },
            { name: "Jodhpur Park Durga Puja", shortName: "Jodhpur Park", category: "South Kolkata" },
            { name: "95 Pally Association", shortName: "95 Pally", category: "South Kolkata" },
            { name: "Babubagan Durgostav", shortName: "Babubagan", category: "South Kolkata" },
            { name: "Kendua Shanti Sangha", shortName: "Kendua", category: "South Kolkata" },
            { name: "Purbachal Shakti Sangha", shortName: "Purbachal", category: "South Kolkata" },
            { name: "Santoshpur Lake Pally", shortName: "Lake Pally", category: "South Kolkata" },
            { name: "Santoshpur Trikon park club ankan potigoti", shortName: "Trikon Park", category: "South Kolkata" },
            { name: "Bosepukur Sitala Madir", shortName: "Bosepukur", category: "South Kolkata" },
            { name: "Pally Mangal Samity Sarbojanin", shortName: "Pally Mangal", category: "South Kolkata" },
            { name: "Rajdanga Naba Uday Sangha", shortName: "Rajdanga", category: "South Kolkata" },
            // Salt Lake & Rajarhat
            { name: "Saltlake AK block", shortName: "AK Block", category: "Salt Lake & Rajarhat" },
            { name: "Newtown Sarbojanin Durgotsav", shortName: "Newtown", category: "Salt Lake & Rajarhat" },
            // Central Kolkata
            { name: "College Square Durga Puja", shortName: "College Sq", category: "Central Kolkata" },
            { name: "Mohammad Ali Park", shortName: "Md Ali Park", category: "Central Kolkata" },
            { name: "Santosh Mitra Square", shortName: "Santosh Mitra", category: "Central Kolkata" },
            { name: "Wellington Nagarik Kalyan Samity", shortName: "Wellington", category: "Central Kolkata" },
            { name: "Beliaghata 33 Pally", shortName: "Beliaghata 33", category: "Central Kolkata" },
            // West Kolkata & Behala
            { name: "Barisha Club Puja Ground and Community Hall", shortName: "Barisha Club", category: "West Kolkata & Behala" },
            { name: "Barisha Sarbojonin", shortName: "Barisha", category: "West Kolkata & Behala" },
            { name: "Behala Natundal Durga Puja", shortName: "Natundal", category: "West Kolkata & Behala" },
            { name: "Thakurpukur State Bank Park", shortName: "SB Park", category: "West Kolkata & Behala" }
        ];

        // --- GLOBAL VARIABLES ---
        let map;
        let userLocation = null;
        let markers = [];
        let directionsService;
        let directionsRenderer;
        let geocoder;
        // *** IMPORTANT: Add your Gemini API Key here ***
        const GEMINI_API_KEY = 'AIzaSyCR9eO8hbW1x8RCpejMCEh1e_dfBCteaYM'; // <= Replace this with your actual key
        let sortedSelectedLocations = [];

        // --- INITIALIZATION & UI SETUP ---
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 22.5726, lng: 88.3639 },
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
            geocoder = new google.maps.Geocoder();
            populateLocationList();
            getUserLocation();
            setupEventListeners();
            renderSavedPlans();
        }

        function setupEventListeners() {
            document.getElementById('plan-generator-btn').addEventListener('click', generateHoppingPlan);
            document.getElementById('save-plan-btn').addEventListener('click', saveCurrentPlan);
            document.getElementById('close-modal-btn').addEventListener('click', () => document.getElementById('gemini-modal').classList.add('hidden'));
            document.getElementById('gemini-modal').addEventListener('click', (e) => {
                if (e.target.id === 'gemini-modal') {
                    document.getElementById('gemini-modal').classList.add('hidden');
                }
            });
            document.getElementById('manual-location-btn').addEventListener('click', setManualLocation);
        }
        
        // --- Populate location list function remains the same ---
        function populateLocationList() {
            const listContainer = document.getElementById('location-list');
            const categories = {};
            locations.forEach((location, index) => {
                const category = location.category || "Uncategorized";
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push({ ...location, originalIndex: index });
            });
            const categoryOrder = ["North Kolkata & Lake Town", "Dum Dum", "South Kolkata", "Salt Lake & Rajarhat", "Central Kolkata", "West Kolkata & Behala"];
            categoryOrder.forEach(categoryName => {
                const locationsInCategory = categories[categoryName];
                if (locationsInCategory && locationsInCategory.length > 0) {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'text-md font-semibold text-gray-600 mt-4 mb-2 px-2 sticky top-0 bg-white';
                    categoryHeader.textContent = categoryName;
                    listContainer.appendChild(categoryHeader);
                    locationsInCategory.forEach(location => {
                        const index = location.originalIndex;
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'flex items-center p-2 rounded-md hover:bg-gray-100 transition-colors';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `loc-${index}`;
                        checkbox.value = index;
                        checkbox.className = 'h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50';
                        checkbox.disabled = true;
                        checkbox.addEventListener('change', updateMapAndList);
                        const label = document.createElement('label');
                        label.htmlFor = `loc-${index}`;
                        label.textContent = location.name;
                        label.className = 'ml-3 text-sm text-gray-700';
                        itemDiv.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        listContainer.appendChild(itemDiv);
                    });
                }
            });
        }


        // --- CORE LOGIC ---
        function getUserLocation() {
            const statusText = document.getElementById('status-text');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
                        statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
                        statusText.textContent = "Location peye gechi! Pandal select korun.";
                        document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => cb.disabled = false);
                        document.getElementById('manual-location-btn').style.display = 'none';
                    },
                    () => handleLocationError(true)
                );
            } else {
                handleLocationError(false);
            }
        }

        function setManualLocation() {
            userLocation = { lat: 22.5679, lng: 88.3526 }; // Esplanade, Kolkata
            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-green-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-green-800');
            statusText.textContent = "Location manually Esplanade set kora hoyeche.";
            document.querySelectorAll('#location-list input[type="checkbox"]').forEach(cb => cb.disabled = false);
            document.getElementById('manual-location-btn').style.display = 'none';
            updateMapAndList(); // Update map after setting manual location
        }

        async function updateMapAndList() {
            if (!userLocation) return;
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            const planButton = document.getElementById('plan-generator-btn');
            const saveButton = document.getElementById('save-plan-btn');
            const helperText = document.getElementById('plan-helper-text');
            const statusText = document.getElementById('status-text');

            if (selectedIndices.length < 2) {
                 planButton.disabled = true;
                 helperText.style.display = 'block';
            } else {
                 planButton.disabled = false;
                 helperText.style.display = 'none';
            }

            saveButton.disabled = selectedIndices.length === 0;

            if (selectedIndices.length === 0) {
                clearMarkers();
                if(directionsRenderer) directionsRenderer.setDirections({ routes: [] });
                document.getElementById('navigation-container').classList.add('hidden');
                return;
            }

            statusText.textContent = "Pandal location-gulo khunje ber korchi...";
            
            const selectedLocationData = selectedIndices.map(index => locations[index]);

            const geocodePromises = selectedLocationData.map(location => {
                return new Promise((resolve, reject) => {
                    // If location already has lat/lng, resolve immediately
                    if (location.lat && location.lng) {
                        resolve(location);
                        return;
                    }
                    geocoder.geocode({ 'address': `${location.name}, Kolkata` }, (results, status) => {
                        if (status === 'OK') {
                            const newLocation = {
                                ...location,
                                lat: results[0].geometry.location.lat(),
                                lng: results[0].geometry.location.lng()
                            };
                            resolve(newLocation);
                        } else {
                            console.error(`Geocode was not successful for "${location.name}": ${status}`);
                            reject(location.name);
                        }
                    });
                });
            });

            const results = await Promise.allSettled(geocodePromises);
            const geocodedLocations = [];
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    geocodedLocations.push(result.value);
                } else {
                    console.warn(`Could not find location for: ${result.reason}`);
                }
            });

            if(geocodedLocations.length === 0) {
                statusText.textContent = "Kono pandal khunje paoa gelo na.";
                return;
            }

            statusText.textContent = `${geocodedLocations.length} ti pandal map-e dekhano hochche.`;


            geocodedLocations.forEach(location => {
                location.distance = getDistance(userLocation, location);
            });
            geocodedLocations.sort((a, b) => a.distance - b.distance);
            
            sortedSelectedLocations = geocodedLocations;

            displaySortedLocationsOnMap(geocodedLocations);
            setupNavigationButton(geocodedLocations);
        }

        function displaySortedLocationsOnMap(sortedLocations) {
            clearMarkers();
            directionsRenderer.setDirections({ routes: [] });
            const bounds = new google.maps.LatLngBounds();

            const userMarker = new google.maps.Marker({
                position: userLocation, map: map, title: 'Your Location',
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
            });
            markers.push(userMarker);
            bounds.extend(userLocation);

            sortedLocations.forEach((location, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng }, 
                    map: map,
                    label: {
                        text: `${index + 1}. ${location.shortName}`,
                        className: 'gmaps-marker-label'
                    },
                    title: `${index + 1}. ${location.name} (${location.distance.toFixed(2)} km away)`
                });
                const infowindow = new google.maps.InfoWindow({ content: `<div><strong>${index + 1}. ${location.name}</strong><br>${location.distance.toFixed(2)} km away</div>` });
                marker.addListener("click", () => infowindow.open({ anchor: marker, map }));
                markers.push(marker);
                bounds.extend(marker.getPosition());
            });

            map.fitBounds(bounds);

            if (sortedLocations.length > 0) {
                const origin = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                const destination = new google.maps.LatLng(sortedLocations[sortedLocations.length - 1].lat, sortedLocations[sortedLocations.length - 1].lng);
                const waypoints = sortedLocations.slice(0, -1).map(loc => ({ location: new google.maps.LatLng(loc.lat, loc.lng), stopover: true }));
                const request = { origin, destination, waypoints, travelMode: google.maps.TravelMode.DRIVING };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        directionsRenderer.setDirections(result);
                    } else {
                        handleDirectionsError(status);
                    }
                });
            }
        }
        
        // --- GEMINI API INTEGRATION ---
        async function generateHoppingPlan() {
            if (sortedSelectedLocations.length < 2) return;

            const modal = document.getElementById('gemini-modal');
            const loader = document.getElementById('modal-loader');
            const planText = document.getElementById('modal-plan-text');
            
            modal.classList.remove('hidden');
            loader.style.display = 'flex';
            planText.innerHTML = '';

            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                planText.innerHTML = `<p class="text-red-500">Dukkhito, Gemini API key deoa nei. Please code-er GLOBAL VARIABLES section-e giye key-ti add korun.</p>`;
                loader.style.display = 'none';
                return;
            }

            const pandalNames = sortedSelectedLocations.map(p => p.name).join(', ');
            
            const prompt = `You are an expert local guide for Kolkata's Durga Puja. A user wants a detailed plan to visit: ${pandalNames}.

For each pandal in the list, perform a comprehensive Google Search to gather the following critical information:

1.  **Parking Information (Very Detailed):**
    * Search for parking arrangements near "[Pandal Name] Durga Puja" for both the previous year and any available real-time information. This is the most critical information.
    * Describe the typical parking situation (e.g., designated parking lot, street parking on specific roads, park-and-ride facility).
    * If you find a specific parking area or lot name (e.g., "XYZ School Ground Parking"), provide a Google Maps URL for it. The URL should be a search link like: \`https://www.google.com/maps/search/?api=1&query=Parking+near+[Pandal Name],+Kolkata\`. If no specific lot is found, create this general search link for parking near the pandal.

2.  **Nearby Restaurants (3 Options):**
    * Find three different, highly-rated restaurants within walking distance.
    * For each restaurant, provide its name and cuisine type (e.g., Bengali, Mughlai, Cafe).

**Output Format:**
-   Do not add any title, introduction, or conclusion.
-   The entire output must be a single HTML \`<ul>\` list.
-   Each pandal should be an \`<li>\` item.
-   Inside each \`<li>\`, use a \`<strong>\` tag for the pandal name.
-   Use nested \`<ul>\` lists for "Parking Details" and "Restaurants".
-   Parking URLs must be clickable \`<a href="..." target="_blank">\` links.
-   At the very end, outside the main list, add a small \`<p>\` with a disclaimer: "Parking information is based on past data and the latest available search results and can change. Please verify on-site."`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({ error: { message: "Could not parse error response." } }));
                    console.error("Gemini API Response Error:", errorBody);
                    throw new Error(`API Error: ${response.status} ${response.statusText}. ${errorBody.error?.message || ''}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    planText.innerHTML = text;
                } else {
                     if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                         planText.innerHTML = `<p class="text-red-500">Dukkhito, kichu safety karone plan-ti toiri kora gelo na. Onno pandal select kore chesta korun.</p>`;
                    } else {
                        throw new Error("No content received from API.");
                    }
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                planText.innerHTML = `<p class="text-red-500">Dukkhito, plan toiri korte samasya hoyeche. Error: ${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
            }
        }

        // --- SAVE/LOAD PLAN LOGIC ---
        function saveCurrentPlan() {
            const selectedIndices = Array.from(document.querySelectorAll('#location-list input:checked')).map(cb => cb.value);
            if (selectedIndices.length === 0) {
                return;
            }

            const planName = prompt("Apnar plan-er ekta naam din:", `My Pujo Plan ${new Date().toLocaleDateString()}`);
            if (planName) {
                const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
                const newPlan = {
                    name: planName,
                    date: new Date().toLocaleDateString(),
                    indices: selectedIndices
                };
                plans.push(newPlan);
                localStorage.setItem('pandalPlans', JSON.stringify(plans));
                renderSavedPlans();
            }
        }

        function renderSavedPlans() {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const listContainer = document.getElementById('saved-plans-list');
            listContainer.innerHTML = ''; // Clear previous list

            if (plans.length === 0) {
                listContainer.innerHTML = `<p class="text-xs text-gray-500 text-center">Kono plan ekhono save kora hoeni.</p>`;
                return;
            }

            plans.forEach((plan, index) => {
                const planEl = document.createElement('div');
                planEl.className = 'p-2 border rounded-md bg-gray-50';
                
                planEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-sm">${plan.name}</p>
                            <p class="text-xs text-gray-500">${plan.date}</p>
                        </div>
                        <div class="flex space-x-1">
                            <button class="load-plan-btn text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">Load</button>
                            <button class="delete-plan-btn text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;

                planEl.querySelector('.load-plan-btn').addEventListener('click', () => loadPlan(index));
                planEl.querySelector('.delete-plan-btn').addEventListener('click', (event) => deletePlan(index, event));
                
                listContainer.appendChild(planEl);
            });
        }

        function loadPlan(index) {
            const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
            const plan = plans[index];
            if (!plan) return;

            // Uncheck all boxes first
            document.querySelectorAll('#location-list input:checked').forEach(cb => cb.checked = false);

            // Check the boxes from the saved plan
            plan.indices.forEach(pandalIndex => {
                const checkbox = document.getElementById(`loc-${pandalIndex}`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });

            // Update the map
            updateMapAndList();
        }

        function deletePlan(index, event) {
            const deleteBtn = event.target;
            
            if (deleteBtn.textContent === 'Delete') {
                deleteBtn.textContent = 'Sure?';
                deleteBtn.classList.replace('bg-red-500', 'bg-yellow-500');
                deleteBtn.classList.replace('hover:bg-red-600', 'hover:bg-yellow-600');
                // Set a timeout to revert the button if not clicked again
                setTimeout(() => {
                    if (deleteBtn.textContent === 'Sure?') {
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.classList.replace('bg-yellow-500', 'bg-red-500');
                        deleteBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-600');
                    }
                }, 3000); // Reverts after 3 seconds
            } else {
                const plans = JSON.parse(localStorage.getItem('pandalPlans')) || [];
                plans.splice(index, 1);
                localStorage.setItem('pandalPlans', JSON.stringify(plans));
                renderSavedPlans();
            }
        }


        // --- UTILITY & ERROR HANDLING ---
        function setupNavigationButton(sortedLocations) {
            const navContainer = document.getElementById('navigation-container');
            const navButton = document.getElementById('start-navigation-btn');
            if (!userLocation || sortedLocations.length === 0) {
                navContainer.classList.add('hidden');
                return;
            }
            let mapsUrl = `https://www.google.com/maps/dir/?api=1`;
            mapsUrl += `&origin=${userLocation.lat},${userLocation.lng}`;
            const destination = sortedLocations[sortedLocations.length - 1];
            mapsUrl += `&destination=${destination.lat},${destination.lng}`;
            if (sortedLocations.length > 1) {
                const waypoints = sortedLocations.slice(0, -1).map(loc => `${loc.lat},${loc.lng}`).join('|');
                mapsUrl += `&waypoints=${waypoints}`;
            }
            navButton.onclick = () => window.open(mapsUrl, '_blank');
            navContainer.classList.remove('hidden');
        }

        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }

        function handleLocationError(browserHasGeolocation) {
            const statusText = document.getElementById('status-text');
            statusText.parentElement.classList.replace('bg-blue-100', 'bg-red-100');
            statusText.parentElement.classList.replace('text-blue-800', 'text-red-800');
            statusText.textContent = browserHasGeolocation ? 'Location permission on korun.' : 'Apnar browser location support kore na.';
            const manualBtn = document.getElementById('manual-location-btn');
            manualBtn.className = "mt-2 font-bold text-indigo-700 underline";
        }
        
        function handleDirectionsError(status) {
            console.warn("Directions request failed due to " + status);
        }
        
        function getDistance(pos1, pos2) {
            const R = 6371;
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 0.5 - Math.cos(dLat)/2 + Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * (1 - Math.cos(dLon))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        window.initMap = initMap;
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBBfulQNrZqVY4kj1CCsWoS13SksshKPZM&callback=initMap&libraries=geocoding">
    </script>
</body>
</html>

